<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>nCipher nShield/netHSM - EJBCA - Documentation Space</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="108530570">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_7.4.3.2_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=78939033"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_7.4.3.2_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Integration.html">EJBCA Integration</a></li>
                                                                                     <li><a href="Hardware_Security_Modules_%28HSM%29.html">Hardware Security Modules (HSM)</a></li>
                                                            </ul>
</div>            <h1 id="src-78939033"> <span>nCipher nShield/netHSM</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>The following covers how the nCipher nShield card is installed and used.</p>
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1JbnN0YWxsYXRpb25JbnN0cnVjdGlvbnM">Installation Instructions</a></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwMS5JbnN0YWxsdGhlblNoaWVsZENhcmQ">Step 1. Install the nShield Card</a></p>
</li><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwMi5TZXR1cEVudmlyb25tZW50">Step 2. Setup Environment</a></p>
</li><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwMy5DcmVhdGVQS0NTIzExS2V5c1VzZWRvbm5TaGllbGRjYXJk">Step 3. Create PKCS#11 Keys Used on nShield card</a></p>
</li><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwNC5TdGFydEVKQkNBd2l0aG5TaGllbGRIU00">Step 4. Start EJBCA with nShield HSM</a></p>
</li><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwNS5DcmVhdGVOZXdDQQ">Step 5. Create New CA</a></p>
</li></ul></li><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1Vc2luZ01vZHVsZVByb3RlY3RlZEtleXM">Using Module Protected Keys</a></p>
</li><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1Ob3RVc2luZ1ByZWxvYWQ">Not Using Preload</a></p>
</li><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1Vc2luZ01vcmVUaGFuT25lT0NT">Using More Than One OCS</a></p>
</li><li class=" "><p   
><a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1uQ2lwaGVyX2xvYWRfYmFsYW5jaW5nbkNpcGhlckxvYWRCYWxhbmNpbmc">nCipher Load Balancing</a></p>
</li></ul>    <div class="section section-1" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1JbnN0YWxsYXRpb25JbnN0cnVjdGlvbnM">
        <h1 class="heading "><span>Installation Instructions</span></h1>
    <div class="section section-2" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwMS5JbnN0YWxsdGhlblNoaWVsZENhcmQ">
        <h2 class="heading "><span>Step 1. Install the nShield Card</span></h2>
<p   
>To install the nShield Card and create admin and operator card sets, do the following:</p>
<ol class=" "><li class=" "><p   
>Make sure you have all necessary software and drivers installed and created the user and group nfast. In Linux should the software be installed to /opt/nfast or the location environment variable NFAST_HOME is pointing to.</p>
</li><li class=" "><p   
>Login as the nfast user: <strong class=" ">sudo su nfast</strong></p>
</li><li class=" "><p   
>Set the nCipher box to initialization mode by setting the switch to mode <strong class=" ">I</strong>.</p>
</li><li class=" "><p   
>Clear the nCipher box by pressing the reset button on the device.</p>
</li><li class=" "><p   
>Check that the mode is in <strong class=" ">pre-initialization mode</strong> and not in <strong class=" ">operational</strong>:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">nfast@donny:</code><code class="plain">/home/lars/work</code><code class="plain">$ </code><code class="plain">/opt/nfast/bin/enquiry</code></div>
<div class="line"><code class="plain">Server:</code></div>
<div class="line"><code class="plain"> enquiry reply flags  none</code></div>
<div class="line"><code class="plain"> enquiry reply level  Six</code></div>
<div class="line"><code class="plain"> serial number        41C5-BA04-6D2C</code></div>
<div class="line"><code class="plain"> mode                 operational</code></div>
<div class="line"><code class="plain"> version              2.23.6</code></div>
<div class="line"><code class="plain"> speed index          147</code></div>
<div class="line"><code class="plain"> rec. queue           442..642</code></div>
<div class="line"><code class="plain"> level one flags      Hardware HasTokens</code></div>
<div class="line"><code class="plain"> version string       2.23.6cam5, 2.22.6cam7 built on Apr 25 2005 18:15:46</code></div>
<div class="line"><code class="plain"> checked </code><code class="keyword">in</code><code class="plain">           00000000431dca98 Tue Sep  6 18:58:00 2005</code></div>
<div class="line"><code class="plain"> level two flags      none</code></div>
<div class="line"><code class="plain"> max. write size      8192</code></div>
<div class="line"><code class="plain"> level three flags    KeyStorage</code></div>
<div class="line"><code class="plain"> level four flags     OrderlyClearUnit HasRTC HasNVRAM HasNSOPermsCmd ServerHasPollCmds FastPollSlotList HasSEE HasKLF HasShareACL HasFeatureEnable HasFileOp HasLongJobs ServerHasLongJobs AESModuleKeys NTokenCmds LongJobsPreferred</code></div>
<div class="line"><code class="plain"> module </code><code class="functions">type</code><code class="plain"> code     0</code></div>
<div class="line"><code class="plain"> product name         nFast server</code></div>
<div class="line"><code class="plain"> device name</code></div>
<div class="line"><code class="plain"> EnquirySix version   4</code></div>
<div class="line"><code class="plain"> impath kx </code><code class="functions">groups</code></div>
<div class="line"><code class="plain"> feature ctrl flags   none</code></div>
<div class="line"><code class="plain"> features enabled     none</code></div>
<div class="line"><code class="plain"> version serial       0</code></div>
<div class="line"><code class="plain"> remote server port   9004</code></div>
<div class="line"><code class="plain">Module </code><code class="comments">#1:</code></div>
<div class="line"><code class="plain"> enquiry reply flags  none</code></div>
<div class="line"><code class="plain"> enquiry reply level  Six</code></div>
<div class="line"><code class="plain"> serial number        41C5-BA04-6D2C</code></div>
<div class="line"><code class="plain"> mode                 pre-initialisation</code></div>
<div class="line"><code class="plain"> version              2.22.6</code></div>
<div class="line"><code class="plain"> speed index          147</code></div>
<div class="line"><code class="plain"> rec. queue           9..152</code></div>
<div class="line"><code class="plain"> level one flags      Hardware HasTokens InitialisationMode PreMaintInitMode</code></div>
<div class="line"><code class="plain"> version string       2.22.6cam7 built on Apr 25 2005 18:15:46</code></div>
<div class="line"><code class="plain"> checked </code><code class="keyword">in</code><code class="plain">           00000000426636cd Wed Apr 20 13:02:37 2005</code></div>
<div class="line"><code class="plain"> level two flags      none</code></div>
<div class="line"><code class="plain"> max. write size      8192</code></div>
<div class="line"><code class="plain"> level three flags    KeyStorage</code></div>
<div class="line"><code class="plain"> level four flags     OrderlyClearUnit HasRTC HasNVRAM HasNSOPermsCmd ServerHasPollCmds FastPollSlotList HasSEE HasKLF HasShareACL HasFeatureEnable HasFileOp HasLongJobs ServerHasLongJobs AESModuleKeys NTokenCmds LongJobsPreferred</code></div>
<div class="line"><code class="plain"> module </code><code class="functions">type</code><code class="plain"> code     6</code></div>
<div class="line"><code class="plain"> product name         nC1002P</code><code class="plain">/nC3022P</code></div>
<div class="line"><code class="plain"> device name          </code><code class="comments">#1 nFast PCI device, bus 0, slot 13.</code></div>
<div class="line"><code class="plain"> EnquirySix version   5</code></div>
<div class="line"><code class="plain"> impath kx </code><code class="functions">groups</code><code class="plain">     DHPrime1024</code></div>
<div class="line"><code class="plain"> feature ctrl flags   LongTerm</code></div>
<div class="line"><code class="plain"> features enabled     StandardKM</code></div>
<div class="line"><code class="plain"> version serial       24</code></div>
<div class="line"><code class="plain"> rec. LongJobs queue  8</code></div>
<div class="line"><code class="plain"> SEE machine </code><code class="functions">type</code><code class="plain">     gen1AIF </code></div>
</div>
    </div>
</li><li class=" "><p   
>Create the security world with the command:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="plain">/opt/nfast/bin/new-world</code><code class="plain"> -i -Q 1</code><code class="plain">/1</code></div>
<div class="line"><code class="plain">15:04:50 WARNING: Module </code><code class="comments">#1: preemptively erasing module to see its slots!</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Create Security World:</code></div>
<div class="line"><code class="plain"> Module 1: 0 cards of 1 written</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: unknown card</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase specified - overwriting card</code></div>
<div class="line"><code class="plain">Card writing complete.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">security world generated on module </code><code class="comments">#0; hknso = 6807e0b031c4f797b739ec33ca7dba05279cf54f</code></div>
<div class="line"><code class="plain">$ </code></div>
</div>
    </div>
<p   
>The <strong class=" ">-Q K/N</strong> option tells how many administration cards that are created N. K of these cards will be needed to restore a module with a backup of the security world. <strong class=" ">1/1</strong> is a bad choice in production but will do in this example. Choose K&gt;=3 and N&gt;K in production.</p>
</li><li class=" "><p   
>Change mode on the switch on the device to mode <strong class=" ">O</strong>.</p>
</li><li class=" "><p   
>Click <strong class=" ">Clear</strong> again.</p>
</li><li class=" "><p   
>Check with <strong class=" ">enquiry</strong> that the mode has changed to <strong class=" ">Operational</strong><br/>Example on creation of operator cards:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="plain">/opt/nfast/bin/createocs</code><code class="plain"> -m 1 -Q 2</code><code class="plain">/3</code><code class="plain"> -N ejbca -M -p -T 0</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Creating Cardset:</code></div>
<div class="line"><code class="plain"> Module 1: 0 cards of 3 written</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: Admin Card </code><code class="comments">#1</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: blank card</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase specified - writing card (naming `EJBCA card 1')</code></div>
<div class="line"><code class="plain"> Module 1: 1 card of 3 written</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: remove already-written card </code><code class="comments">#1</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: blank card</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase specified - writing card (naming `EJBCA card 2')</code></div>
<div class="line"><code class="plain"> Module 1: 2 cards of 3 written</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: remove already-written card </code><code class="comments">#2</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: blank card</code></div>
<div class="line"><code class="plain">New passphrases </code><code class="keyword">do</code><code class="plain"> not match; please try again.</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase specified - writing card (naming `EJBCA card 3')</code></div>
<div class="line"><code class="plain">Card writing complete.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">cardset created; hkltu = 8d30f2ab5bdccacd8a4333aefed2c0ea1ff0e6db</code></div>
<div class="line"><code class="plain">$ </code></div>
</div>
    </div>
<p   
>This will generate 3 cards of the card set named <strong class=" ">ejbca</strong>. Any 2 of these cards will be needed when generating keys and starting ejbca. Different card sets could be used for different CAs.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>The preload command (see below) must always be called as the same user unless the directory /opt/nfast/kmdata/preload is removed.<br/>If you get a <strong class=" ">HostDataAccessDenied</strong> error when running preload or starting JBoss, it is because the file permissions on the directory /opt/nfast/kmdata/preload is wrong. It's probably because you (sometime) ran preload as another user, such as root or nfast.</p>
        </div>
    </div>
</li><li class=" "><p   
>Load the card set so that keys protected by the card set could be generated (card set named <strong class=" ">ejbca</strong>):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="plain">/opt/nfast/bin/preload</code><code class="plain"> -c ejbca pause</code></div>
<div class="line"><code class="plain">Loading cardsets:</code></div>
<div class="line"><code class="plain">ejbca on modules 1</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Loading `ejbca':</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: `ejbca</code><code class="string">' #3 (`EJBCA card 3'</code><code class="plain">)</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase supplied - reading card</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: `ejbca</code><code class="string">' #3 (`EJBCA card 3'</code><code class="plain">): already </code><code class="functions">read</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: `ejbca</code><code class="string">' #2 (`EJBCA card 2'</code><code class="plain">)</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase supplied - reading card</code></div>
<div class="line"><code class="plain">Card reading complete.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Loading complete; now pausing </code></div>
</div>
    </div>
</li></ol>    </div>
    <div class="section section-2" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwMi5TZXR1cEVudmlyb25tZW50">
        <h2 class="heading "><span>Step 2. Setup Environment</span></h2>
<p   
>To set environments variables required before generating keys and installing a new CA, do the following.</p>
<p   
>Login as the user that is running the application server. This user must be a member of the nfast group.</p>
<p   
>The following environment variables should be set for this user:</p>
<ul class=" "><li class=" "><p   
>JAVA_HOME (/usr/local/jdk1.6.0_16 or similar)</p>
</li><li class=" "><p   
>APPSRV_HOME (/home/jboss/jboss-5.1.0.GA or similar)</p>
</li><li class=" "><p   
>EJBCA_HOME (/home/jboss/ejbca or similar)</p>
</li><li class=" "><p   
>NFAST_HOME (/opt/nfast)</p>
</li></ul>    </div>
    <div class="section section-2" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwMy5DcmVhdGVQS0NTIzExS2V5c1VzZWRvbm5TaGllbGRjYXJk">
        <h2 class="heading "><span>Step 3. Create PKCS#11 Keys Used on nShield card</span></h2>
<p   
>To create the PKCS#11 keys that should be used on the nShield card, do the following:</p>
<ol class=" "><li class=" "><p   
>Start a new window and login as the same user (jboss user).</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>An <strong class=" ">ECC</strong> key could not be used with preload (at least not the curve secp160r1). Such a key is generated OK and could be used as long as the current preload is running. But if all preload processes are stopped and then if then preload is restarted the key could not be used. This means that ECC could only be used with a 1/n OCS.</p>
        </div>
    </div>
</li><li class=" "><p   
>Now 3 keys protected by the key set <strong class=" ">ejbca</strong> are created like this:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c ejbca $EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 4096 defaultRoot i1</code></div>
<div class="line"><code class="plain">Executing ejbcaClientToolBox.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 4096 defaultRoot i1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-NFastJava] Password: </code></div>
<div class="line"><code class="plain">Creating certificate with entry default.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c ejbca $EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 2048 cryptRoot i1</code></div>
<div class="line"><code class="plain">Loaded pkcs11 uc17cfc7c330e613af5709789ff823a476177e233c-d165e440baa8dc9963780c682836ba17513e8cbf key (RSAPrivate) on modules 1</code></div>
<div class="line"><code class="plain">Executing ejbcaClientToolBox.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 2048 cryptRoot i1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-NFastJava] Password: </code></div>
<div class="line"><code class="plain">Creating certificate with entry crypt.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c ejbca $EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 1024 </code><code class="functions">test</code><code class="plain"> i1</code></div>
<div class="line"><code class="plain">Loaded pkcs11 uc17cfc7c330e613af5709789ff823a476177e233c-27cfdae84bf4298f2dde83cd00980a81bcf095bf key (RSAPrivate) on modules 1</code></div>
<div class="line"><code class="plain">Executing ejbcaClientToolBox.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 1024 </code><code class="functions">test</code><code class="plain"> i1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-NFastJava] Password: </code></div>
<div class="line"><code class="plain">Creating certificate with entry </code><code class="functions">test</code><code class="plain">. </code></div>
</div>
    </div>
</li></ol>    </div>
    <div class="section section-2" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwNC5TdGFydEVKQkNBd2l0aG5TaGllbGRIU00">
        <h2 class="heading "><span>Step 4. Start EJBCA with nShield HSM</span></h2>
<p   
>To start EJBCA, preload must be running with the required key stores loaded. In this example this was done in step 2. Preload is now used to start JBoss/WildFly:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c ejbca $APPSRV_HOME</code><code class="plain">/bin/standalone</code><code class="plain">.sh </code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1TdGVwNS5DcmVhdGVOZXdDQQ">
        <h2 class="heading "><span>Step 5. Create New CA</span></h2>
<p   
>To create a new CA, perform the following in the EJBCA Admin Web:</p>
<p   
>Choose PKCS#11 as <strong class=" ">CA Token Type</strong>.</p>
<p   
>Properties are defined according to the <a   href="#src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1HZW5lcmljX1BLQ1NfMTFfcHJvdmlkZXI">Generic PKCS#11 provider </a>section above.</p>
<p   
>All preloaded operator card sets (OCSs) has its own slot. It is not possible to predict the slot ID. But the index of the slot in the slot list is predictable. <strong class=" ">slotListIndex</strong> must therefore be used. If only one OCS is preloaded this index is always 1.</p>
<p   
>If several CAs are sharing the same OCS (and hence slot) each key (identified by a key label) may only be used for one CA but the test key. Same test key could be used for all CAs.</p>
<p   
>Example with previous generated keys where signRoot is used for CAs signing, and defaultRoot is used for everything else (encryption):</p>
<p   
>When preload is used no authentication code is needed to activate a CA. You could give any value for the authentication code when activating. The <strong class=" ">pin</strong> property could be used in the configuration to automatically activate a CA. The value of this property could be anything.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">defaultKey defaultRoot</code></div>
<div class="line"><code class="plain">testKey </code><code class="functions">test</code></div>
<div class="line"><code class="plain">keyEncryptKey cryptRoot</code></div>
<div class="line"><code class="plain">hardTokenEncrypt cryptRoot</code></div>
<div class="line"><code class="plain">pin dummy</code></div>
<div class="line"><code class="plain">slotLabelType SLOT_INDEX</code></div>
<div class="line"><code class="plain">slotLabelValue 1</code></div>
<div class="line"><code class="plain">sharedLibrary </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so </code></div>
</div>
    </div>
    </div>
    </div>
    <div class="section section-1" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1Vc2luZ01vZHVsZVByb3RlY3RlZEtleXM">
        <h1 class="heading "><span>Using Module Protected Keys</span></h1>
<p   
>Module protected keys do not need an operator card set. Hence no PIN code is needed to active such a key. A CA could be configured to use a keystore with module protected keys.</p>
<p   
>When using PKCS#11 slot index 0 is used to indicate module protection. The only other thing except using slot index 0 you have to do is to use a configuration file when creating the key. The file could look like this when using clientToolBox:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">name=NFastJava</code></div>
<div class="line"><code class="plain">library=/opt/nfast/toolkits/pkcs11/libcknfast.so</code></div>
<div class="line"><code class="plain">slotListIndex=0</code></div>
<div class="line"><code class="plain">attributes(*,CKO_PUBLIC_KEY,*) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = false</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">attributes(*,CKO_PRIVATE_KEY,*) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = true</code></div>
<div class="line"><code class="plain">  CKA_PRIVATE = false</code></div>
<div class="line"><code class="plain">  CKA_SIGN = true</code></div>
<div class="line"><code class="plain">  CKA_DECRYPT = true</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">disabledMechanisms = {</code></div>
<div class="line"><code class="plain">  CKM_SHA1_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA256_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA384_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA512_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_MD2_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_MD5_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_DSA_SHA1</code></div>
<div class="line"><code class="plain">  CKM_ECDSA_SHA1</code></div>
<div class="line"><code class="plain">} </code></div>
</div>
    </div>
<p   
>When adding it as an attributes file to be used in the Admin UI, the rows <i class=" ">name</i>, <i class=" ">library</i> and <i class=" ">slitListIndex</i> must be removed, as they are added by your selection in the UI. Hence you need two files, one for usage with clientToolBox and one for usage in the Admin UI.</p>
    </div>
    <div class="section section-1" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1Ob3RVc2luZ1ByZWxvYWQ">
        <h1 class="heading "><span>Not Using Preload</span></h1>
<p   
>If a 1/N card set is used, then preload don't have to be used (but it can be used). If preload is not used, then jboss could be made to start automatically at boot time.</p>
<p   
>For PKCS#11 simply do not use the preload command. The authentication code is now needed when activating the CA.</p>
    </div>
    <div class="section section-1" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1Vc2luZ01vcmVUaGFuT25lT0NT">
        <h1 class="heading "><span>Using More Than One OCS</span></h1>
<p   
>It is also possible to use more than one OCS. This is needed when you want different CAs protected by different OCSs.</p>
<p   
>The key to get this working is to set the environment variable CKNFAST_LOADSHARING=1. This environment variable is also implicitly set when running with preload.</p>
<p   
>To get a list of all available slots do:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ CKNFAST_LOADSHARING=1 ~nfast</code><code class="plain">/bin/ckinfo</code></div>
<div class="line"><code class="plain">PKCS</code><code class="comments">#11 library CK_INFO</code></div>
<div class="line"><code class="plain">       interface version 2.01</code></div>
<div class="line"><code class="plain">                   flags 0</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">      libraryDescription </code><code class="string">"nCipher PKCS#11 1.58.48         "</code></div>
<div class="line"><code class="plain">  implementation version 1.58</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[0] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"                                                                "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 5</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_TOKEN_PRESENT</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[0] CK_TOKEN_INFO</code></div>
<div class="line"><code class="plain">                   label </code><code class="string">"loadshared accelerator          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   model </code><code class="string">"                "</code></div>
<div class="line"><code class="plain">            serialNumber </code><code class="string">"                "</code></div>
<div class="line"><code class="plain">                   flags 201</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_RNG</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_DUAL_CRYPTO_OPERATIONS</code></div>
<div class="line"><code class="plain">       ulMaxSessionCount 1024</code></div>
<div class="line"><code class="plain">     ulMaxRwSessionCount 1024</code></div>
<div class="line"><code class="plain">             ulMaxPinLen 18446744073709551615</code></div>
<div class="line"><code class="plain">             ulMinPinLen 0</code></div>
<div class="line"><code class="plain">     ulTotalPublicMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">      ulFreePublicMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">    ulTotalPrivateMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">     ulFreePrivateMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"><code class="plain">                 utcTime </code><code class="string">"                "</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[1] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"1of2_0                                                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 6</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[1] Token not present</code></div>
<div class="line"><code class="plain">slots[2] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"2of3_0                                                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 6</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[2] Token not present</code></div>
<div class="line"><code class="plain">slots[3] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"ejbca                                                           "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 6</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[3] Token not present</code></div>
<div class="line"><code class="plain">slots[4] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"2of3_1                                                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 6</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[4] Token not present</code></div>
<div class="line"><code class="plain">slots[5] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"1of2_1                                                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 7</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_TOKEN_PRESENT</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[5] CK_TOKEN_INFO</code></div>
<div class="line"><code class="plain">                   label </code><code class="string">"1of2_1                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   model </code><code class="string">"                "</code></div>
<div class="line"><code class="plain">            serialNumber </code><code class="string">"ee6071c52a77370c"</code></div>
<div class="line"><code class="plain">                   flags 20D</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_RNG</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_LOGIN_REQUIRED</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_USER_PIN_INITIALIZED</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_DUAL_CRYPTO_OPERATIONS</code></div>
<div class="line"><code class="plain">       ulMaxSessionCount 1024</code></div>
<div class="line"><code class="plain">     ulMaxRwSessionCount 1024</code></div>
<div class="line"><code class="plain">             ulMaxPinLen 18446744073709551615</code></div>
<div class="line"><code class="plain">             ulMinPinLen 0</code></div>
<div class="line"><code class="plain">     ulTotalPublicMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">      ulFreePublicMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">    ulTotalPrivateMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">     ulFreePrivateMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"><code class="plain">                 utcTime </code><code class="string">"                "</code><code class="plain"> </code></div>
</div>
    </div>
<p   
>You then got to identify your OCSs with the slot index. The <strong class=" ">label</strong> in the list gives the name you gave to your OCS when creating it. Then you get the slot list index from the <strong class=" ">x</strong> in <strong class=" ">slot[x]</strong>. Use this for <strong class=" ">slotListIndex</strong> in the CA properties.</p>
<p   
>When using a 1/n OCS one card of the OCS must be inserted when activating a CA. If the OCS is persistent then the card could be removed and you could then activate another CA by inserting its OCS.</p>
<p   
>To make the OCS persistent use the <strong class=" ">-p</strong> argument at <strong class=" ">createocs</strong> time, if this is not the case as soon as the card is removed then the cardset will unload itself.</p>
<p   
>When using k/n OCS where k&gt;1 you got to load all OCSs to be used with preload and then start the application server also with preload. Example:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c 2of3_0 pause</code></div>
<div class="line"><code class="plain">-- follow instruction to insert cards and enter pins. --</code></div>
<div class="line"><code class="plain">-- </code><code class="keyword">then</code><code class="plain"> press ctr-z --</code></div>
<div class="line"><code class="plain">$ </code><code class="functions">bg</code><code class="plain"> </code></div>
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c 2of3_1 </code><code class="functions">exit</code></div>
<div class="line"><code class="plain">-- follow instruction to insert cards and enter pins. -- </code></div>
</div>
    </div>
<p   
>When the application server then is started with preload, CAs defined for slot list index 2 and 4 could be activated. When activating a CA when running preload no PIN has to be given. Also when the application server is started with preload then only CAs of preloaded slots could be activated (not preloaded 1/n slots could not be used).</p>
    </div>
    <div class="section section-1" id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1uQ2lwaGVyX2xvYWRfYmFsYW5jaW5nbkNpcGhlckxvYWRCYWxhbmNpbmc">
        <h1 class="heading "><span id="src-78939033_safe-id-aWQtLm5DaXBoZXJuU2hpZWxkL25ldEhTTXY3LjMuMC1uQ2lwaGVyX2xvYWRfYmFsYW5jaW5n" class="confluence-anchor-link"></span><span>nCipher Load Balancing</span></h1>
<p   
>If you want to use the Loadsharing with multiple modules, be it PCI cards of NetHSM's then you must ensure you have a 1/N OCS and the N quorum to be able to have enough cards to be inserted in every HSM you want to load balance the key at server/CA start up when logging in.<br/>Same security world got to be loaded in all modules participating.<br/>After setting up the first netHSM, do the following on the second:</p>
<ul class=" "><li class=" "><p   
>Use the panel of the second netHSM to configure the rfs</p>
</li><li class=" "><p   
>Use the panel of the second netHSM to load the security world</p>
</li><li class=" "><p   
>Use the panel of the second netHSM to configure clients</p>
</li><li class=" "><p   
>on each client run: /opt/nfast/bin/nethsmenroll</p>
</li></ul><p   
>With load balancing you need to have CKNFAST_LOADSHARING=1. Preload implicitly sets CKNFAST_LOADSHARING.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>If preload is used fail-over to the other HSM if one of the HSMs is broken is not working.</p>
        </div>
    </div>
<p   
>Example of starting jboss:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">ejbca@host:</code><code class="plain">/usr/local/ejbca</code><code class="plain">&gt; CKNFAST_LOADSHARING=1 ..</code><code class="plain">/jboss/bin/standalone</code><code class="plain">.sh</code></div>
</div>
    </div>
<p   
>When activating a CA you need a smart card from the OCS of the corresponding slot inserted in both HSMs. The OCS got to be 1/n since preload can not be used.<br/>Sample catoken.properties for generating the initial ManagementCA on the netHSM.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">defaultKey defaultKey</code></div>
<div class="line"><code class="plain">certSignKey defaultSign</code></div>
<div class="line"><code class="plain">crlSignKey defaultSign</code></div>
<div class="line"><code class="plain">testKey testKey</code></div>
<div class="line"><code class="plain">sharedLibrary </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so</code></div>
<div class="line"><code class="plain">slotLabelType=SLOT_INDEX</code></div>
<div class="line"><code class="plain">slotLabelValue 1</code></div>
</div>
    </div>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Google_KMS.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Google KMS</span>
        </a>
                <a href="Nitrokey_HSM.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Nitrokey HSM</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
