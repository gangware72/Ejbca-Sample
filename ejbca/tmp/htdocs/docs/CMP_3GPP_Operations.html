<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CMP 3GPP Operations - EJBCA - Documentation Space</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="108530570">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_7.4.3.2_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=100271853"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_7.4.3.2_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations.html">EJBCA Operations</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations_Guide.html">EJBCA Operations Guide</a></li>
                                                                                                         <li class="shortcut"><a href="CA_Operations_Guide.html">CA Operations Guide</a></li>
                                                                                                         <li class="shortcut"><a href="Enrollment_Protocol_Configuration.html">Enrollment Protocol Configuration</a></li>
                                                                                     <li><a href="CMP_Operations_Guide.html">CMP Operations Guide</a></li>
                                                            </ul>
</div>            <h1 id="src-100271853"> <span>CMP 3GPP Operations</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>The following describes how to configure CMP for 3GPP and covers common operations and testing.</p>
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-ConfiguringEJBCAforDirectCA-BaseStationCommunication">Configuring EJBCA for Direct CA - Base Station Communication</a></p>
</li><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-ConfiguringEJBCAforCA-BaseStationCommunicationThroughanRA">Configuring EJBCA for CA - Base Station Communication Through an RA</a></p>
</li><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-EnrollingDevicewithVendorCertificate">Enrolling Device with Vendor Certificate</a></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-ThreelevelVendorPKIHierarchy">Three level Vendor PKI Hierarchy</a></p>
</li></ul></li><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-eNodeBEnrollmentExample">eNodeB Enrollment Example</a></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-Prerequisites">Prerequisites</a></p>
</li><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-Pre-registeringeNodeB">Pre-registering eNodeB</a></p>
</li><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-eNodeBOperation">eNodeB Operation</a></p>
</li><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-Renewal">Renewal</a></p>
</li><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-UsinganExternalRAoverPeers">Using an External RA over Peers</a></p>
</li><li class=" "><p   
><a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-VariationsDiscovered">Variations Discovered</a></p>
</li></ul></li></ul>    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>This page describes configuration and operations for using EJBCA with 3GPP. For more information on the CMP 3GPP standard and EJBCA's integration with it, see the <a   href="Using_CMP_with_3GPP.html">3GPP Overview</a> page.</p>
        </div>
    </div>
    <div class="section section-1" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-ConfiguringEJBCAforDirectCA-BaseStationCommunication">
        <h1 class="heading "><span>Configuring EJBCA for Direct CA - Base Station Communication</span></h1>
<p   
><span id="src-100271853_id-.CMP3GPPOperationsv7.4.3-directca"></span></p>
<p   
>    <span style="color: #0e101a;">
To configure EJBCA for Direct CA - Base Station Communication, click <strong class=" ">CMP Configuration </strong>under<strong class=" "> System Functions </strong>and configure a CMP Alias with the following configuration:    </span>
<strong class=" ">    <span style="color: #0e101a;">
<br/>    </span>
</strong></p>
    <div  class="tablewrap">
        <table class="relative-table wrapped confluenceTable">
                    <colgroup>
                                    <col  width="45%"/>
                                    <col  width="54%"/>
                            </colgroup>
        <thead class=" ">    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Configuration Option</p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Setting</p>
            </td>
        </tr>
</thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>CMP Operational Mode</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Client Mode</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>CMP Authentication Mode</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>EndEntityCertificate</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Vendor Certificate Mode</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Use and specify the name of the Vendor CA</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow Automatic Key Update</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow Certificate Renewal with Same Keys</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow</p>
            </td>
        </tr>
</tbody>        </table>
            </div>
<p   
>    <span style="color: #0e101a;">
The CMP Operational Mode     </span>
    <span style="color: #0e101a;">
<strong class=" ">Client mode</strong> works like any other enrollment in EJBCA. When a request comes in, EJBCA verifies the request (see     </span>
<a   href="CMP.html">    <span style="color: #4a6ee0;">
CMP Message Authentication    </span>
</a>    <span style="color: #0e101a;">
) and issues a certificate to a user that has been previously registered in EJBCA. For more information on CMP operational modes, see <a   href="CMP.html">CMP</a>.<br/>    </span>
</p>
<p   
>    <span style="color: #0e101a;">
The following displays the settings on the Edit CMP Alias page:    </span>
</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/Screenshot_2020-02-12_at_11.58.37.png" alt="images/download/attachments/100271853/Screenshot_2020-02-12_at_11.58.37.png" width="800"  />
    </p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/Screenshot_2020-02-12_at_11.58.48.png" alt="images/download/attachments/100271853/Screenshot_2020-02-12_at_11.58.48.png" width="800"  />
    </p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/Screenshot_2020-02-12_at_11.59.19.png" alt="images/download/attachments/100271853/Screenshot_2020-02-12_at_11.59.19.png" width="800"  />
    </p>
<p   
>    <span style="color: #000000;">
Note that EJBCA always authenticates an update request using only the EndEntityCertificate module, no matter how many authentication modules are configured. However, in order for the update request to authenticate successfully, EndEntityCertificate module has to be set as one of the used authentication modules.    </span>
</p>
    </div>
    <div class="section section-1" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-ConfiguringEJBCAforCA-BaseStationCommunicationThroughanRA">
        <h1 class="heading "><span>Configuring EJBCA for CA - Base Station Communication Through an RA</span></h1>
<p   
><span id="src-100271853_id-.CMP3GPPOperationsv7.4.3-throughra"></span></p>
<p   
>    <span style="color: #0e101a;">
To configure EJBCA for Direct CA - Base Station Communication through an RA, click <strong class=" ">CMP Configuration </strong>under<strong class=" "> System Functions </strong>and configure a CMP Alias with the following configuration:    </span>
</p>
    <div  class="tablewrap">
        <table class="relative-table wrapped confluenceTable">
                    <colgroup>
                                    <col  width="30%"/>
                                    <col  width="69%"/>
                            </colgroup>
        <thead class=" ">    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Configuration Option</p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Setting</p>
            </td>
        </tr>
</thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>CMP Operational Mode</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>RA Mode</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>CMP Authentication Mode</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>EndEntityCertificate, and specify the issuer of the certificate in the extraCerts<br/>field.</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>RA Name Generation Scheme</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>DN and specify the DN part to be usee as the username</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow Automatic Key Update</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>RA End Entity Profile</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>The name of the End Entity Profile to be used when adding Entities representing the substations</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>RA Certificate Profile</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>ProfileDefault or the name of the Certificate Profile to be used when creating certificates for the substations</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>RA CA Name</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>ProfileDefault or the name of the CA to be used when creating End Entities and certificates for the substations</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow Automatic Key Update</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow Certificate Renewal with Same Keys</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Allow</p>
            </td>
        </tr>
</tbody>        </table>
            </div>
<p   
>    <span style="color: #0e101a;">
The CMP Operational Mode <strong class=" ">RA Mode</strong> is u    </span>
    <span style="color: #0e101a;">
sed when the CMP client acts as an RA to EJBCA (the RA sends a certificate request to EJBCA). No user is pre-registered in EJBCA, but when authenticated RA CMP messages arrive, a user is created in EJBCA and a certificate is issued.     </span>
    <span style="color: #0e101a;">
For more information on CMP operational modes, see <a   href="CMP.html">CMP</a>.<br/>    </span>
</p>
<p   
>    <span style="color: #0e101a;">
The following displays the settings on the Edit CMP Alias page:    </span>
</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/Screenshot_2020-02-12_at_13.24.45.png" alt="images/download/attachments/100271853/Screenshot_2020-02-12_at_13.24.45.png" width="800"  />
    </p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/Screenshot_2020-02-12_at_13.26.40.png" alt="images/download/attachments/100271853/Screenshot_2020-02-12_at_13.26.40.png" width="800"  />
    </p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/Screenshot_2020-02-12_at_13.27.09.png" alt="images/download/attachments/100271853/Screenshot_2020-02-12_at_13.27.09.png" width="800"  />
    </p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/Screenshot_2020-02-12_at_13.25.17.png" alt="images/download/attachments/100271853/Screenshot_2020-02-12_at_13.25.17.png" width="800"  />
    </p>
    </div>
    <div class="section section-1" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-EnrollingDevicewithVendorCertificate">
        <h1 class="heading "><span>Enrolling Device with Vendor Certificate</span></h1>
<p   
>    <span style="color: #000000;">
A PKI workflow as specified in the 3GPP standard uses CMP to enroll a device, authenticating the initial request using a Vendor certificate added to the device at manufacturing. After initial enrollment, the device can automatically renew the certificate when it is about to expire.    </span>
</p>
<ol class=" "><li class=" "><p   
>    <span style="color: #000000;">
There is a Vendor Root CA and a Vendor Sub CA that issues a Vendor Certificate to the device, with which is comes pre-provisioned from the factory.    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
The Vendor Root CA is trusted for initial enrollment, for devices pre-registered in EJBCA with parts of the DN (usually device serial number).    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
We want to generate two certificates for the device, one for IPSEC and one for TLS, and thus the Vendor Certificate is used for multiple authentications to different end entities.    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Generate two new key pairs on the device    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Initial enrollment of an IPSEC Certificate for the new key on the device uses certificate authentication with the Vendor Certificate on the device.    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Initial enrollment of a TLS Certificate for the new key on the device uses certificate authentication with the Vendor Certificate on the device.    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Generate two new key pairs on the device    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Renew the IPSEC certificate for the new key pair, authenticated using the old key pair and certificate    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Renew the TLS certificate for the new key pair, authenticated using the old key pair and certificate    </span>
</p>
</li></ol><p   
>    <span style="color: #000000;">
The above steps can be simulated in reality using the <i class=" ">cmpforopenssl</i> client, but also using the    </span>
 <a   href="CMP.html">EJBCA cmpclient</a>.</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>In this example we show how to issue both IPSec certificates and TLS certificates. Depending on your use case you may only need one of these, and not both.</p>
        </div>
    </div>
<p   
>    <span style="color: #000000;">
This works with two cmpaliases configured with parameters:    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CMP Alias: aliasIPSEC</code></div>
<div class="line"><code class="plain">CMP Operational Mode: Client</code></div>
<div class="line"><code class="plain">CMP Authentication Module : EndEntityCertificate</code></div>
<div class="line"><code class="plain">Extract Username Component : CN</code></div>
<div class="line"><code class="plain">RA Name Generation Postfix : _IPSEC</code></div>
<div class="line"><code class="plain">Vendor Certificate Mode: Use</code></div>
<div class="line"><code class="plain">List Of Vendor CAs: Add Vendor Root CA (imported as External CA </code><code class="keyword">in</code><code class="plain"> EJBCA)</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">CMP Alias: aliasTLS</code></div>
<div class="line"><code class="plain">CMP Operational Mode: Client</code></div>
<div class="line"><code class="plain">CMP Authentication Module : EndEntityCertificate</code></div>
<div class="line"><code class="plain">Extract Username Component : CN</code></div>
<div class="line"><code class="plain">RA Name Generation Postfix : _TLS</code></div>
<div class="line"><code class="plain">Vendor Certificate Mode: Use</code></div>
<div class="line"><code class="plain">List Of Vendor CAs: Add Vendor Root CA (imported as External CA </code><code class="keyword">in</code><code class="plain"> EJBCA</code></div>
</div>
    </div>
<p   
>The Vendor Certificate is issued (suggested as a key store with the private key) from Vendor Sub CA the with subjectDN: CN=1234.primekey.com,O=PrimeKey,C=SE</p>
<ol class=" "><li class=" "><p   
>Generate key pairs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ .</code><code class="plain">/openssl</code><code class="plain"> genrsa -out certs</code><code class="plain">/ipsec_key</code><code class="plain">.pem 2048 </code></div>
<div class="line"><code class="plain">$ .</code><code class="plain">/openssl</code><code class="plain"> genrsa -out certs</code><code class="plain">/tls_key</code><code class="plain">.pem 2048 </code></div>
</div>
    </div>
</li><li class=" "><p   
>Initial enrollment:<br/>Before initial enrollment you add two new End Entities in EJBCA, in this example with user name 1234.primekey.com_IPSEC and 1234.primekey.com_TLS with subject DN 'CN=ipsec1234' resp. 'CN=hostname1234'.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ openssl </code><code class="functions">cmp</code><code class="plain"> -cmd ir -server localhost:8080 -path ejbca</code><code class="plain">/publicweb/cmp/aliasIPSEC</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">	-cert VendorDeviceCert.pem -key VendorDeviceKey.pem -certout operator_ipsec_cert.pem -newkey ipsec_key.pem \</code></div>
<div class="line"><code class="plain">	-subject </code><code class="string">"/CN=ipsec1234"</code><code class="plain"> -extracerts VendorExtraCerts.pem -trusted IPSECROOTRSA.cacert.pem \</code></div>
<div class="line"><code class="plain">	-implicit_confirm </code></div>
<div class="line"> </div>
<div class="line"><code class="plain">$ openssl </code><code class="functions">cmp</code><code class="plain"> -cmd ir -server localhost:8080 -path ejbca</code><code class="plain">/publicweb/cmp/aliasTLS</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">	-cert VendorDeviceCert.pem -key VendorDeviceKey.pem -certout operator_tls_cert.pem -newkey tls_key.pem \</code></div>
<div class="line"><code class="plain">	-subject </code><code class="string">"/CN=hostname1234"</code><code class="plain"> -extracerts VendorExtraCerts.pem -trusted TLSROOTRSA.cacert.pem \</code></div>
<div class="line"><code class="plain">	-implicit_confirm </code></div>
</div>
    </div>
</li><li class=" "><p   
>Generate new key pairs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ .</code><code class="plain">/openssl</code><code class="plain"> genrsa -out certs</code><code class="plain">/ipsec_new_key</code><code class="plain">.pem 2048</code></div>
<div class="line"><code class="plain">$ .</code><code class="plain">/openssl</code><code class="plain"> genrsa -out certs</code><code class="plain">/tls_new_key</code><code class="plain">.pem 2048</code></div>
</div>
    </div>
</li><li class=" "><p   
>Renew with new certificates:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ openssl </code><code class="functions">cmp</code><code class="plain"> -cmd kur -server localhost:8080 -path ejbca</code><code class="plain">/publicweb/cmp/aliasIPSEC</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">	-cert ipsec_cert.pem -key ipsec_key.pem -certout ipsec_new_cert.pem -newkey ipsec_new_key.pem \</code></div>
<div class="line"><code class="plain">	-subject </code><code class="string">"/CN=ipsec1234"</code><code class="plain"> -extracerts IPSECCAcerts.pem -trusted IPSECROOTRSA.cacert.pem \</code></div>
<div class="line"><code class="plain">	-implicit_confirm</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">$ openssl </code><code class="functions">cmp</code><code class="plain"> -cmd kur -server localhost:8080 -path ejbca</code><code class="plain">/publicweb/cmp/aliasTLS</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">	-cert tls_cert.pem -key tls_key.pem -certout tls_new_cert.pem -newkey tls_new_key.pem \</code></div>
<div class="line"><code class="plain">	-subject </code><code class="string">"/CN=hostname1234"</code><code class="plain"> -extracerts TLSCAcerts.pem -trusted TLSROOTRSA.cacert.pem \</code></div>
<div class="line"><code class="plain">	-implicit_confirm</code></div>
</div>
    </div>
</li></ol>    <div class="section section-2" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-ThreelevelVendorPKIHierarchy">
        <h2 class="heading "><span>Three level Vendor PKI Hierarchy</span></h2>
<p   
>Vendor CA hierarchies can be either two or three levels, i.e. either Root CA&rarr;DeviceID or Root CA&rarr;Sub CA&rarr;DeviceID. <a  class="external-link" href="https://www.3gpp.org/ftp/Specs/archive/33_series/33.310/">3GPP 33.310</a> section 9.5.4.2 says that in a three level hierarchy the base station certificate and the intermediate certificate shall be included in the extraCerts field of the CMP request.</p>
<p   
>The following displays an example <tt class=" ">cmpforopenssl</tt> command to test Vendor CA authentication with a three level Vendor CA PKI:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/cmpclient</code><code class="plain"> --server 127.0.0.1 --port 8080 --path ejbca</code><code class="plain">/publicweb/cmp/vendor</code><code class="plain"> --srvcert 3GPPCA.cacert.pem --ir --subject </code><code class="string">"C=SE,O=Test,CN=Network Element 32"</code><code class="plain"> --clcert nevcert.pem --newclcert nev-</code><code class="functions">op</code><code class="plain">-crt.der --newkey nev-</code><code class="functions">op</code><code class="plain">-key.pem --key nevkey.pem --extracert casubnevcert.pem</code></div>
</div>
    </div>
    </div>
    </div>
    <div class="section section-1" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-eNodeBEnrollmentExample">
        <h1 class="heading "><span>eNodeB Enrollment Example</span></h1>
<p   
>    <span style="color: #000000;">
To assist in configuring eNodeB enrollment in accordance with    </span>
 <a  class="external-link" href="https://www.3gpp.org/ftp/Specs/archive/33_series/33.310/">3GPP 33.310</a>,     <span style="color: #000000;">
the following provides a full working example of an EJBCA configuration as well as simulated eNodeB enrollment messages using    </span>
 <a  class="external-link" href="https://github.com/openssl/openssl">OpenSSL v3</a> (OpenSSL v3 includes the CMP client).</p>
    <div class="section section-2" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-Prerequisites">
        <h2 class="heading "><span>Prerequisites</span></h2>
<p   
>    <span style="color: #000000;">
To complete the 3GPP PKI configuration and eNodeB enrollment, the following prerequisites must be fulfilled:    </span>
</p>
    <div class="section section-3" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-AnOperatorCAcreatedinEJBCA">
        <h3 class="heading "><span>An Operator CA created in EJBCA</span></h3>
<p   
>    <span style="color: #000000;">
The Operator CA hierarchy can be one or more levels deep and use any algorithm matching the eNodeB capabilities. In the following example, an Operator Root CA is created that issues end entity certificates directly, using a prime256r1 EC Key and SHA256WithECDSA.<br/>    </span>
</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/5gca-2.png" alt="images/download/attachments/100271853/5gca-2.png" width="600"  />
    </p>
    </div>
    <div class="section section-3" id="src-100271853_safe-id-aWQtLkNNUDNHUFBPcGVyYXRpb25zdjcuNC4zLUFjZXJ0aWZpY2F0ZVByb2ZpbGVhbmRFbmRFbnRpdHlQcm9maWxlY3JlYXRlZGluRUpCQ0Fmb3JJc3N1aW5ndGhlZU5vZGVCKEVuZEVudGl0eSlDZXJ0aWZpY2F0ZXM">
        <h3 class="heading "><span>A certificate Profile and End Entity Profile created in EJBCA for Issuing the eNodeB (End Entity) Certificates</span></h3>
<p   
>The certificate profile is configured to issue end entity certificates suitable for TLS client connections, this means that the Key Usage is suitable for the key type (different for RSA and EC) and Extended Key Usage <strong class=" ">clientAuthentication. </strong>Other fields should be specified as required by your certificate policy.</p>
<p   
>The end entity profile is configured to allow eNodeBs to enroll with:</p>
<ul class=" "><li class=" "><p   
>CN: For example <a  class="external-link" href="http://210305854210K8002536.vendor.com">210305854210K8002536.vendor.com.</a></p>
</li><li class=" "><p   
>OU: For example Wireless Network Product Line.</p>
</li><li class=" "><p   
>O: For example Vendor.</p>
</li><li class=" "><p   
>C: For example SE.</p>
</li><li class=" "><p   
>DnsNames : For example <a  class="external-link" href="http://210305854210K8002536.vendor.com">210305854210K8002536.vendor.com.</a></p>
</li></ul><p   
>And should have the configured 3GPP CA and certificate profile selected as available CAs.</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/ee-1.png" alt="images/download/attachments/100271853/ee-1.png" width="400"  />
    </p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Do not select other CAs and profiles here as that affects possible needed access rules, see <a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-UsinganExternalRAoverPeers">Using an External RA over Peers</a>.</p>
        </div>
    </div>
    </div>
    <div class="section section-3" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-TheVendorRootCACertificatefromtheeNodeBVendorImportedinEJBCA">
        <h3 class="heading "><span>The Vendor Root CA Certificate from the eNodeB Vendor Imported in EJBCA</span></h3>
<p   
>    <span style="color: #000000;">
The following provides a sample three-level Vendor CA hierarchy with the Root CA. The following example uses ECDSA to make the certificate shorter to copy-paste, but RSA works just as well.    </span>
</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Note that Vendors are not restricted to having only one Vendor Root CA, but can have different Vendor CA hierarchies for different products lines, for example eNodeB vs SecGW.</p>
        </div>
    </div>
<p   
></p>
<p   
>    <span style="color: #000000;">
Here is the VendorRootCAEC384.cacert.pem certificate for our example.<br/>    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">-----BEGIN CERTIFICATE-----</code></div>
<div class="line"><code class="plain">MIIB5zCCAY2gAwIBAgIIfIFBpHsapFAwCgYIKoZIzj0EAwMwRzELMAkGA1UEBhMC</code></div>
<div class="line"><code class="plain">U0UxGTAXBgNVBAoMEFByaW1lS2V5IEZhY3RvcnkxHTAbBgNVBAMMFFZlbmRvciBS</code></div>
<div class="line"><code class="plain">b290IENBIEVDMzg0MB4XDTIwMTAxOTA2MjExMloXDTQwMTAxNDA2MjExMlowRzEL</code></div>
<div class="line"><code class="plain">MAkGA1UEBhMCU0UxGTAXBgNVBAoMEFByaW1lS2V5IEZhY3RvcnkxHTAbBgNVBAMM</code></div>
<div class="line"><code class="plain">FFZlbmRvciBSb290IENBIEVDMzg0MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE</code></div>
<div class="line"><code class="plain">Pg1gVL60dcs+pI0xqdt+ZxFsi0z0PM/++tXy3CTN1MIL+UL7hjIbHZoKHDydDjvX</code></div>
<div class="line"><code class="plain">Jh2wNEvR1uby3XIwg0+zVaNjMGEwDwYDVR0TAQH</code><code class="plain">/BAUwAwEB/zAfBgNVHSMEGDAW</code></div>
<div class="line"><code class="plain">gBSK0LnIltrD+4XTciuLinXtYpk</code><code class="plain">/yzAdBgNVHQ4EFgQUitC5yJbaw/uF03Iri4p1</code></div>
<div class="line"><code class="plain">7WKZP8swDgYDVR0PAQH</code><code class="plain">/BAQDAgGGMAoGCCqGSM49BAMDA0gAMEUCIQDsFbCpZbxA</code></div>
<div class="line"><code class="plain">tPYrCaNm+8viymtxgW59rrUqbi4GweEqBQIgMvS0OeKVASGAeBIUoI3GBgszzVgj</code></div>
<div class="line"><code class="plain">M6MzBjOO586jzSs=</code></div>
<div class="line"><code class="plain">-----END CERTIFICATE-----</code></div>
<div class="line"> </div>
<div class="line"><code class="functions">cat</code><code class="plain"> &gt; VendorRootCAEC384.cacert.pem</code></div>
</div>
    </div>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>In some cases, an intermediate (Sub CA) from the Vendor certificate must also be imported, see <a   href="#src-100271853_id-.CMP3GPPOperationsv7.4.3-Variations">Variations</a>.</p>
        </div>
    </div>
    </div>
    <div class="section section-3" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-CMPAlias">
        <h3 class="heading "><span>CMP Alias</span></h3>
<p   
>A CMP alias must be added according to the following:</p>
<ul class=" "><li class=" "><p   
>Name: 5GeNodeB (freely choosable label, but is part of the URL used by eNodeBs)</p>
</li><li class=" "><p   
>CMP Client Mode</p>
</li><li class=" "><p   
>CMP Authentication Module: EndEntityCertificate</p>
</li><li class=" "><p   
>Extract Username Component: CN</p>
</li><li class=" "><p   
>Vendor Certificate Mode: true</p>
</li><li class=" "><p   
>Adding the Vendor Root CA as vendor CA</p>
</li><li class=" "><p   
>Default CA: 5GCA</p>
</li><li class=" "><p   
>Automatic Key Update: true</p>
</li></ul><p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/cmpalias.png" alt="images/download/attachments/100271853/cmpalias.png" width="600"  />
    </p>
    </div>
    </div>
    <div class="section section-2" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-Pre-registeringeNodeB">
        <h2 class="heading "><span>Pre-registering eNodeB</span></h2>
<p   
>    <span style="color: #000000;">
The eNodeB to be authorized for enrollment must be added to EJBCA in order to authorize this specific eNodeB to receive an Operator certificate to be able to communicate on the Operators network. The end entity can be added using the CLI, UI or using the WS or REST API.    </span>
</p>
<p   
>    <span style="color: #000000;">
The CN typically matches the serial number of the device to be enrolled. Often a DNSName is also added, in case the eNodeB should act as server-side in TLS communication. The password passed on the command line is not needed for the enrollment and can be set to a random value, or if password is not required in the end entity profile, can be set to 'null'.<br/>    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">bin</code><code class="plain">/ejbca</code><code class="plain">.sh ra addendentity --username 1234.primekey.com --dn </code><code class="string">"CN=1234.primekey.com,O=PrimeKey Mobile Operator,C=SE"</code><code class="plain"> --altname </code><code class="string">"DNSName=1234.primekey.com"</code><code class="plain"> --caname 5GCA --eeprofile=3GPP --certprofile=3GPP --</code><code class="functions">type</code><code class="plain"> 1 --token USERGENERATED --password ZUhgGPuu-doesnt-matter-randomize</code></div>
</div>
    </div>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/100271853/edd-ee.png" alt="images/download/attachments/100271853/edd-ee.png" width="400"  />
    </p>
    </div>
    <div class="section section-2" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-eNodeBOperation">
        <h2 class="heading "><span>eNodeB Operation</span></h2>
<p   
>    <span style="color: #000000;">
To enroll to an Operator certificate, the eNodeB must send the Vendor certificates, eNodeB, and Sub CA, in the extraCerts field of the CMP request, the eNodeB certificate must be first in the chain according to <a  class="external-link" href="https://www.3gpp.org/ftp/Specs/archive/33_series/33.310/">3GPP 33.310</a> section 9.5.4.2.    </span>
</p>
<p   
>    <span style="color: #000000;">
The following provides the eNodeBVendorKey.pem (device vendor private key), eNodeBVendorCert.pem (device vendor certificate), and VendorSubCAEC384.cacert.pem (vendor Sub CA certificate).<br/>    </span>
</p>
<p   
>    <span style="color: #000000;">
In the eNodeB terminal, create the needed certificate files:    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="functions">cat</code><code class="plain"> &gt; eNodeBVendorKey.pem</code></div>
<div class="line"><code class="plain">-----BEGIN PRIVATE KEY-----</code></div>
<div class="line"><code class="plain">MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgUmy7YVUMGuemV637</code></div>
<div class="line"><code class="plain">Vcq91ZNL9WAnF56fC1dThaGy5T6gCgYIKoZIzj0DAQehRANCAASyrEYCkTX4ApjD</code></div>
<div class="line"><code class="plain">R9E36V63cUgkZwD4raKpGMZ6jO2RnfPjtcalGK1sDdlF+GSh9XpLul9GibPiDLIX</code></div>
<div class="line"><code class="plain">Ten4Un2I</code></div>
<div class="line"><code class="plain">-----END PRIVATE KEY-----</code></div>
<div class="line"> </div>
<div class="line"><code class="functions">cat</code><code class="plain"> &gt; eNodeBVendorCert.pem</code></div>
<div class="line"><code class="plain">-----BEGIN CERTIFICATE-----</code></div>
<div class="line"><code class="plain">MIIB2DCCAX2gAwIBAgIIVZHqvoM7h7wwCgYIKoZIzj0EAwMwRTELMAkGA1UEBhMC</code></div>
<div class="line"><code class="plain">U0UxGTAXBgNVBAoMEFByaW1lS2V5IEZhY3RvcnkxGzAZBgNVBAMMElZlbmRvciBT</code></div>
<div class="line"><code class="plain">dWJDQSBFQzM4NDAeFw0yMDEwMTkwNjIyNTlaFw00MDEwMTQwNjIxMTJaMDwxCzAJ</code></div>
<div class="line"><code class="plain">BgNVBAYTAlNFMREwDwYDVQQKDAhQcmltZUtleTEaMBgGA1UEAwwRMTIzNC5wcmlt</code></div>
<div class="line"><code class="plain">ZWtleS5jb20wWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAASyrEYCkTX4ApjDR9E3</code></div>
<div class="line"><code class="plain">6V63cUgkZwD4raKpGMZ6jO2RnfPjtcalGK1sDdlF+GSh9XpLul9GibPiDLIXTen4</code></div>
<div class="line"><code class="plain">Un2Io2AwXjAMBgNVHRMBAf8EAjAAMB8GA1UdIwQYMBaAFOAbHblwsKqYhl4u5DX9</code></div>
<div class="line"><code class="plain">hBpNKAAWMB0GA1UdDgQWBBRln9C8ctMywHZ+Azk4IsZnu0HmXzAOBgNVHQ8BAf8E</code></div>
<div class="line"><code class="plain">BAMCB4AwCgYIKoZIzj0EAwMDSQAwRgIhAImjJNNR2LkSWBBmThF3SrhErXtFB5t6</code></div>
<div class="line"><code class="plain">T9AZPqRXnuGQAiEAt9RUxTqGc0d4olxtsMU7O</code><code class="plain">/yJ/L2OayUruRjOOZZHLcc</code><code class="plain">=</code></div>
<div class="line"><code class="plain">-----END CERTIFICATE-----</code></div>
<div class="line"> </div>
<div class="line"><code class="functions">cat</code><code class="plain"> &gt; VendorSubCAEC384.cacert.pem</code></div>
<div class="line"><code class="plain">-----BEGIN CERTIFICATE-----</code></div>
<div class="line"><code class="plain">MIIB5jCCAYugAwIBAgIIc8lyzz9D+tQwCgYIKoZIzj0EAwMwRzELMAkGA1UEBhMC</code></div>
<div class="line"><code class="plain">U0UxGTAXBgNVBAoMEFByaW1lS2V5IEZhY3RvcnkxHTAbBgNVBAMMFFZlbmRvciBS</code></div>
<div class="line"><code class="plain">b290IENBIEVDMzg0MB4XDTIwMTAxOTA2MjE0MVoXDTQwMTAxNDA2MjExMlowRTEL</code></div>
<div class="line"><code class="plain">MAkGA1UEBhMCU0UxGTAXBgNVBAoMEFByaW1lS2V5IEZhY3RvcnkxGzAZBgNVBAMM</code></div>
<div class="line"><code class="plain">ElZlbmRvciBTdWJDQSBFQzM4NDBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABP4c</code></div>
<div class="line"><code class="plain">764FiC2EPqHqkHmRn7OdQoinqWe73yKfBSdTxppnQntMW1oq4kkO1A9qxWgiBN4f</code></div>
<div class="line"><code class="plain">nvx</code><code class="plain">/oByN38Pe1Sl0w1yjYzBhMA8GA1UdEwEB/wQFMAMBAf8wHwYDVR0jBBgwFoAU</code></div>
<div class="line"><code class="plain">itC5yJbaw</code><code class="plain">/uF03Iri4p17WKZP8swHQYDVR0OBBYEFOAbHblwsKqYhl4u5DX9hBpN</code></div>
<div class="line"><code class="plain">KAAWMA4GA1UdDwEB</code><code class="plain">/wQEAwIBhjAKBggqhkjOPQQDAwNJADBGAiEAhWK79GK75Y</code><code class="plain">++</code></div>
<div class="line"><code class="plain">uVLcF6TK2+FWvF0bN820Fwsdmzqsk1ACIQCkwGxvCmZ5RBclq3aWS37wnfucxqeU</code></div>
<div class="line"><code class="plain">6efhzZTOTcKwGA==</code></div>
<div class="line"><code class="plain">-----END CERTIFICATE-----</code></div>
<div class="line"> </div>
<div class="line"><code class="functions">cat</code><code class="plain"> eNodeBVendorCert.pem VendorSubCAEC384.cacert.pem &gt; VendorExtraCerts.pem</code></div>
</div>
    </div>
<p   
>    <span style="color: #000000;">
For initial enrollment, the eNodeB needs the CA certificate of the Operator CA, 3GPP CA. Using OpenSSL for simulation, you need it beforehand, but controlling the code on the eNodeB it can in thoery grab it from the caCerts field of the CMP response. Consult your eNodeB documentation for more information.    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="functions">cat</code><code class="plain"> &gt; Operator5GCA.cacert.pem</code></div>
<div class="line"><code class="plain">-----BEGIN CERTIFICATE-----</code></div>
<div class="line"><code class="plain">MIIB1TCCAXugAwIBAgIUdVQacClwDaymDHvc4Jur3EgSZ7QwCgYIKoZIzj0EAwIw</code></div>
<div class="line"><code class="plain">ODELMAkGA1UEBhMCU0UxGjAYBgNVBAoMEVByaW1lS2V5IE9wZXJhdG9yMQ0wCwYD</code></div>
<div class="line"><code class="plain">VQQDDAQ1R0NBMB4XDTIwMTAxOTA3NDk0NVoXDTMwMTAxNzA3NDk0NVowODELMAkG</code></div>
<div class="line"><code class="plain">A1UEBhMCU0UxGjAYBgNVBAoMEVByaW1lS2V5IE9wZXJhdG9yMQ0wCwYDVQQDDAQ1</code></div>
<div class="line"><code class="plain">R0NBMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEIv0auwTmMXCfj3nCsVJAIRCU</code></div>
<div class="line"><code class="plain">iC55jCLaKwoRu9Pa2S1ugeh66LbAV80A5WGiq+NkzJdr8c9lE</code><code class="plain">/Hyz2W/KldoCKNj</code></div>
<div class="line"><code class="plain">MGEwDwYDVR0TAQH</code><code class="plain">/BAUwAwEB/zAfBgNVHSMEGDAWgBQC57BXQLTWiCCPlaDY5QBA</code></div>
<div class="line"><code class="plain">1dpC7jAdBgNVHQ4EFgQUAuewV0C01oggj5Wg2OUAQNXaQu4wDgYDVR0PAQH</code><code class="plain">/BAQD</code></div>
<div class="line"><code class="plain">AgGGMAoGCCqGSM49BAMCA0gAMEUCIC7J67</code><code class="plain">/LLFW65QD5W1WP/SLD2ZhUVUTV2</code><code class="plain">++k</code></div>
<div class="line"><code class="plain">31gbEYvwAiEA95pLBSW9gRD2zHVve6WCGO0JNq+AGWdHqUynR9SMVtE=</code></div>
<div class="line"><code class="plain">-----END CERTIFICATE-----</code></div>
</div>
    </div>
<p   
>    <span style="color: #000000;">
The eNodeB generates a new key pair to issue in the CMP initial request.    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">openssl ecparam -name prime256v1 -genkey -noout -out eNodeBOperatorKey.pem</code></div>
</div>
    </div>
<p   
>    <span style="color: #000000;">
Make the request to the CA (with hostname ejbca.example.com) and receive the issued Operator certificate back:    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">openssl </code><code class="functions">cmp</code><code class="plain"> -cmd ir -server ejbca.example.com:8080 -path ejbca</code><code class="plain">/publicweb/cmp/5GeNodeB</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">-cert eNodeBVendorCert.pem -key eNodeBVendorKey.pem -certout eNodeBOperatorCert.pem -newkey eNodeBOperatorKey.pem \</code></div>
<div class="line"><code class="plain">-subject </code><code class="string">"/CN=1234.primekey.com/O=PrimeKey Mobile Operator/C=SE"</code><code class="plain"> -sans </code><code class="string">"1234.primekey.com"</code><code class="plain"> -extracerts VendorExtraCerts.pem -srvcert Operator5GCA.cacert.pem -trusted Operator5GCA.cacert.pem \</code></div>
<div class="line"><code class="plain">-implicit_confirm</code></div>
</div>
    </div>
<p   
>    <span style="color: #000000;">
A command line output similar to the following is shown when the (simulated) eNodeB stores the Operator certificate.    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">user@host:~/cmp$ openssl cmp -cmd ir -server ejbca.example.com:8080 -path ejbca/publicweb/cmp/5GeNodeB -cert eNodeBVendorCert.pem -key eNodeBVendorKey.pem -certout eNodeBOperatorCert.pem -newkey eNodeBOperatorKey.pem -subject "/CN=1234.primekey.com/O=PrimeKey Mobile Operator/C=SE" -extracerts VendorExtraCerts.pem -svrcert Operator5GCA.cacert.pem -srvcert Operator5GCA.cacert.pem -trusted Operator5GCA.cacert.pem -implicit_confirm</code></div>
<div class="line"><code class="plain">setup_client_ctx:apps/cmp.c:1980:CMP info: will contact http://ejbca.example.com:8080/ejbca/publicweb/cmp/5GeNodeB</code></div>
<div class="line"><code class="plain">CMP info: sending IR</code></div>
<div class="line"><code class="plain">CMP info: received IP</code></div>
<div class="line"><code class="plain">save_free_certs:apps/cmp.c:2029:CMP info: received 1 enrolled certificate(s), saving to file 'eNodeBOperatorCert.pem'</code></div>
</div>
    </div>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>You may specify different altNames, using the <tt class=" ">-sans</tt> switch, but unless <tt class=" ">override</tt> options are specified in the certificate profile, these are ignored and only the values registered in the end entity in EJBCA are used. For security reasons, values sent from the client are by default not trusted.</p>
        </div>
    </div>
    </div>
    <div class="section section-2" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-Renewal">
        <h2 class="heading "><span>Renewal</span></h2>
<p   
>    <span style="color: #000000;">
Whe    </span>
n renewing the eNodeB Operator certificate the eNodeB generates a new key pair and issues a CMP renewal request, signed with the old Operator certificate. Here the old Operator certificate and Operator Sub CA certificate are used as extraCerts (see 3GPP section TODO). Since we are signed directly by the Operator Root CA, we only need to include the old TLS certificate in extraCerts, the Root CA is already trusted by the server.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">openssl ecparam -name prime256v1 -genkey -noout -out eNodeBOperatorKey-new.pem</code></div>
</div>
    </div>
<p   
>Renewing the certificate, the (simulated) eNodeB sends a CMP KeyUpdate request, signed with the revious operator key and certificate.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">openssl </code><code class="functions">cmp</code><code class="plain"> -cmd kur -server ejbca.example.com:8080 -path ejbca</code><code class="plain">/publicweb/cmp/5GeNodeB</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">-cert eNodeBOperatorCert.pem -key eNodeBOperatorKey.pem -certout eNodeBOperatorCert-new.pem -newkey eNodeBOperatorKey-new.pem \</code></div>
<div class="line"><code class="plain">-extracerts eNodeBOperatorCert.pem -trusted Operator5GCA.cacert.pem \</code></div>
<div class="line"><code class="plain">-implicit_confirm</code></div>
</div>
    </div>
<p   
>This should result in similar output to this on the command line, when the (simulated) eNodeB stores the Operator certificate.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">user@host:~/cmp$ openssl cmp -cmd kur -server ejbca.example.com:8080 -path ejbca/publicweb/cmp/5GeNodeB -cert eNodeBOperatorCert.pem -key eNodeBOperatorKey.pem -certout eNodeBOperatorCert-new.pem -newkey eNodeBOperatorKey-new.pem -extracerts eNodeBOperatorCert.pem -trusted Operator5GCA.cacert.pem -implicit_confirm</code></div>
<div class="line"><code class="plain">setup_client_ctx:apps/cmp.c:1980:CMP info: will contact http://ejbca.example.com:8080/ejbca/publicweb/cmp/5GeNodeB</code></div>
<div class="line"><code class="plain">CMP info: sending KUR</code></div>
<div class="line"><code class="plain">CMP info: received KUP</code></div>
<div class="line"><code class="plain">save_free_certs:apps/cmp.c:2029:CMP info: received 1 enrolled certificate(s), saving to file 'eNodeBOperatorCert-new.pem'</code></div>
</div>
    </div>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p  class="moz-quote-pre" 
>Neither CMP (RFC4210) nor <a  class="external-link" href="https://www.3gpp.org/ftp/Specs/archive/33_series/33.310/">3GPP 33.310</a> mandate any specific times when key update can occur. Hence an eNodeB may send a Key Update Request (kur) at any time, as long as it is authenticated using the old certificate/key.</p>
        </div>
    </div>
    </div>
    <div class="section section-2" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-UsinganExternalRAoverPeers">
        <h2 class="heading "><span>Using an External RA over Peers </span></h2>
<p   
>    <span style="color: #000000;">
When using an External RA in front of EJBCA, using Peer Connectors from the CA, the RAs Peer Connection certificate limits the capabilities of the RA using access roles and rules. To complete enrollment of eNodeB certificates over a Peer Connection, the Peer Connectors Role must include access rules for:    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #000000;">
Operator Issuing CAs    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Issuing End Entity Profiles    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Vendor CAs as added as External CAs in EJBCA    </span>
</p>
</li></ul><p   
>    <span style="color: #000000;">
If you have any missing access rules you will get log entries like the following in the CA log:    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">2020-10-15 13:05:55,593 INFO</code></div>
<div class="line"><code class="plain">[org.cesecore.authorization.AuthorizationSessionBean] (EJB default -</code></div>
<div class="line"><code class="plain">34) Authorization failed for 10.11.96.4 [via] CN=primepki-peer1,C=SE of type AlwaysAllowLocalAuthenticationToken for resource</code></div>
<div class="line"><code class="plain">/ca/1471073378</code></div>
</div>
    </div>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>As of EJBCA 7.4.3, an external CA cannot be added using the simple access rule configuration in <strong class=" ">Peer Systems &gt; Authorized Request</strong> but must be added to the role in Advanced Mode access rules. There is a danger when using the simple <strong class=" ">Authorized Request</strong> button to remove the advanced access rules, so this button cannot be used until External CAs can be added in this simplified configuration mode.</p>
        </div>
    </div>
    </div>
    <div class="section section-2" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-VariationsDiscovered">
        <h2 class="heading "><span>Variations Discovered</span></h2>
    <div class="section section-3" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-VendorCAHierarchiesinextraCerts">
        <h3 class="heading "><span>Vendor CA Hierarchies in extraCerts</span></h3>
<p   
>Vendor CA hierarchies can be either two or three levels, i.e. either Root CA&rarr;DeviceID or Root CA&rarr;Sub CA&rarr;DeviceID. <a  class="external-link" href="https://www.3gpp.org/ftp/Specs/archive/33_series/33.310/">3GPP 33.310</a> section 9.5.4.2 says that in a three-level hierarchy the base station certificate and the intermediate certificate shall be included in the extraCerts field of the CMP request. Although this is stated in the standard, some variations occur.</p>
<ul class=" "><li class=" "><p   
>Fortinet SecGW only includes the end entity certificate in the extraCerts field of the request. This means that the Vendor Sub CA must be added as Vendor CA in the CMP alias in order to verify the end entity certificate chain. This means that both the Vendor Root CA and Vendor Sub CA must be imported in EJBCA as External CAs, and only the Sub CA added as Vendor CA in the CMP alias.</p>
</li><li class=" "><p   
>Huawei eNodeBs also includes the Root CA certificate, as well as the end entity and Sub CA certificates, in the extraCerts field of the request. The Root CA certificate is redundant but works well when configuring the Root CA as Vendor CA in the CM alias (as the Root CA certificate can be verified by the Root CA certificate).</p>
</li><li class=" "><p   
>Ericsson has been known to use a four-level hierarchy, and sends all of them in the extraCerts field. This works for the same reason as above.</p>
</li></ul>    </div>
    <div class="section section-3" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-CommonNameofissuedOperatorcertificates">
        <h3 class="heading "><span>Common Name of issued Operator certificates</span></h3>
<p   
>The CN of the eNodeB Vendor certificate may for example be 210305854210K8002536.vendor.com, but the desired CN of the Operator issue eNodeB certificate is only 210305854210K8002536. This is possible to achieve by pre-registering the end entity with CN 210305854210K8002536, but setting the username of the end entity to 210305854210K8002536.vendor.com. When an enrollment request comes in, the end entity is looked up based on the full subjecDN of the request (which matches the Operators desired name) and hence the username is found regardless if it matches this CN or not, but when verifying the Vendor certificate the username is mapped from the CN in the vendor certificate and hence the username matches the CN of the Vendor certificate.</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Other fields than the CN can be used to match a Vendor certificate to an end entity username, but using CN is the most common and used in this example.</p>
        </div>
    </div>
    </div>
    <div class="section section-3" id="src-100271853_id-.CMP3GPPOperationsv7.4.3-ImplicitConfirm">
        <h3 class="heading "><span>Implicit Confirm</span></h3>
<p   
>The above examples use of the flag <tt class=" ">Implicit_confirm,</tt> which lets the client (eNodeB) get the Operator certificate without sending a CMP Confirm message back to the CA. Regardless of the eNodeB uses <tt class=" ">implicit_confirm</tt> or not, EJCBA will answer properly. It is then important that the <tt class=" ">-srvcert</tt> parameter to the openssl command is provided, as it will otherwise target the CertConf message to the wrong CA.</p>
    </div>
    </div>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="CMP_Operations_Guide.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>CMP Operations Guide</span>
        </a>
                <a href="CMP_Client_Support.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>CMP Client Support</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
