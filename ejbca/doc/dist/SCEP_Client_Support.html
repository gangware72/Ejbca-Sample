<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>SCEP Client Support - EJBCA - Documentation Space</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="108530570">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_7.4.3.2_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=85927560"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_7.4.3.2_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations.html">EJBCA Operations</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations_Guide.html">EJBCA Operations Guide</a></li>
                                                                                                         <li class="shortcut"><a href="CA_Operations_Guide.html">CA Operations Guide</a></li>
                                                                                                         <li class="shortcut"><a href="Enrollment_Protocol_Configuration.html">Enrollment Protocol Configuration</a></li>
                                                                                     <li><a href="SCEP_Operations_Guide.html">SCEP Operations Guide</a></li>
                                                            </ul>
</div>            <h1 id="src-85927560"> <span>SCEP Client Support</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>This page provides code samples and information required when creating a SCEP client. These code samples are not maintained, and may not be in accordance with future versions of BouncyCastle.</p>
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-85927560_id-.SCEPClientSupportv7.4.0-GeneratingaPKCSREQMessage">Generating a PKCSREQ Message</a></p>
</li><li class=" "><p   
><a   href="#src-85927560_id-.SCEPClientSupportv7.4.0-GeneratingaGetCRLMessage">Generating a GetCRL Message</a></p>
</li><li class=" "><p   
><a   href="#src-85927560_id-.SCEPClientSupportv7.4.0-GeneratingaGetCertInitialMessage">Generating a GetCertInitial Message</a></p>
</li><li class=" "><p   
><a   href="#src-85927560_id-.SCEPClientSupportv7.4.0-ParsingaSCEPResponse">Parsing a SCEP Response</a></p>
</li></ul>    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>All classes found in this page, not in the standard Java libraries, are either from BouncyCastle or in EJBCA.</p>
        </div>
    </div>
    <div class="section section-1" id="src-85927560_id-.SCEPClientSupportv7.4.0-GeneratingaPKCSREQMessage">
        <h1 class="heading "><span>Generating a PKCSREQ Message</span></h1>
<p   
>A basic PKCSREQ (certificate request) is a standard PKCS10 certificate request wrapped in a PKCS7 envelope. To do so, the following code can be found in the EJBCA protocol tests:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] generateCertReq(String dn, String password, String transactionId, X509Certificate ca, Extensions exts,</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">final</code><code class="plain"> X509Certificate senderCertificate, </code><code class="keyword">final</code><code class="plain"> PrivateKey signatureKey, ASN1ObjectIdentifier encryptionAlg) </code><code class="keyword">throws</code><code class="plain"> OperatorCreationException, CertificateException,</code></div>
<div class="line"><code class="plain">            IOException, CMSException {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Generate keys</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Create challenge password attribute for PKCS10</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Attributes { ATTRIBUTE:IOSet } ::= SET OF Attribute{{ IOSet }}</code></div>
<div class="line"><code class="plain">        </code><code class="comments">//</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Attribute { ATTRIBUTE:IOSet } ::= SEQUENCE {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">//    type    ATTRIBUTE.&amp;id({IOSet}),</code></div>
<div class="line"><code class="plain">        </code><code class="comments">//    values  SET SIZE(1..MAX) OF ATTRIBUTE.&amp;Type({IOSet}{\@type})</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// }</code></div>
<div class="line"><code class="plain">        ASN1EncodableVector challpwdattr = </code><code class="keyword">new</code><code class="plain"> ASN1EncodableVector();</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Challenge password attribute</code></div>
<div class="line"><code class="plain">        challpwdattr.add(PKCSObjectIdentifiers.pkcs_9_at_challengePassword); </code></div>
<div class="line"><code class="plain">        ASN1EncodableVector pwdvalues = </code><code class="keyword">new</code><code class="plain"> ASN1EncodableVector();</code></div>
<div class="line"><code class="plain">        pwdvalues.add(</code><code class="keyword">new</code><code class="plain"> DERUTF8String(password));</code></div>
<div class="line"><code class="plain">        challpwdattr.add(</code><code class="keyword">new</code><code class="plain"> DERSet(pwdvalues));</code></div>
<div class="line"><code class="plain">        ASN1EncodableVector extensionattr = </code><code class="keyword">new</code><code class="plain"> ASN1EncodableVector();</code></div>
<div class="line"><code class="plain">        extensionattr.add(PKCSObjectIdentifiers.pkcs_9_at_extensionRequest);</code></div>
<div class="line"><code class="plain">        extensionattr.add(</code><code class="keyword">new</code><code class="plain"> DERSet(exts));</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Complete the Attribute section of the request, the set (Attributes) contains two sequences (Attribute)</code></div>
<div class="line"><code class="plain">        ASN1EncodableVector v = </code><code class="keyword">new</code><code class="plain"> ASN1EncodableVector();</code></div>
<div class="line"><code class="plain">        v.add(</code><code class="keyword">new</code><code class="plain"> DERSequence(challpwdattr));</code></div>
<div class="line"><code class="plain">        v.add(</code><code class="keyword">new</code><code class="plain"> DERSequence(extensionattr));</code></div>
<div class="line"><code class="plain">        DERSet attributes = </code><code class="keyword">new</code><code class="plain"> DERSet(v);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Create PKCS#10 certificate request</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">final</code><code class="plain"> PKCS10CertificationRequest p10request = CertTools.genPKCS10CertificationRequest(</code><code class="string">"SHA256WithRSA"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">                CertTools.stringToBcX500Name(reqdn), keys.getPublic(), attributes, keys.getPrivate(), </code><code class="keyword">null</code><code class="plain">);    </code></div>
<div class="line"><code class="plain">        </code><code class="comments">// wrap message in pkcs#7</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> wrap(p10request.getEncoded(), Integer.toString(ScepRequestMessage.SCEP_TYPE_PKCSREQ), transactionId, senderCertificate, signatureKey, encryptionAlg);</code></div>
<div class="line"><code class="plain">    }</code></div>
</div>
    </div>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">    </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] wrap(</code><code class="keyword">byte</code><code class="plain">[] envBytes, String messageType, String transactionId, </code><code class="keyword">final</code><code class="plain"> X509Certificate senderCertificate,</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">final</code><code class="plain"> PrivateKey signatureKey, ASN1ObjectIdentifier encryptionAlg) </code><code class="keyword">throws</code><code class="plain"> CertificateEncodingException, CMSException, IOException {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Create inner enveloped data</code></div>
<div class="line"><code class="plain">        CMSEnvelopedData ed = envelope(</code><code class="keyword">new</code><code class="plain"> CMSProcessableByteArray(envBytes), encryptionAlg);</code></div>
<div class="line"><code class="plain">        log.debug(</code><code class="string">"Enveloped data is "</code><code class="plain"> + ed.getEncoded().length + </code><code class="string">" bytes long"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        CMSTypedData msg = </code><code class="keyword">new</code><code class="plain"> CMSProcessableByteArray(ed.getEncoded());</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Create the outer signed data</code></div>
<div class="line"><code class="plain">        CMSSignedData s = sign(msg, messageType, transactionId, senderCertificate, signatureKey);</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">byte</code><code class="plain">[] ret = s.getEncoded();</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> ret;</code></div>
<div class="line"><code class="plain">    }</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-85927560_id-.SCEPClientSupportv7.4.0-GeneratingaGetCRLMessage">
        <h1 class="heading "><span>Generating a GetCRL Message </span></h1>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] generateCrlReq(String dn, String transactionId, X509Certificate ca, </code><code class="keyword">final</code><code class="plain"> X509Certificate senderCertificate,</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">final</code><code class="plain"> PrivateKey signatureKey, ASN1ObjectIdentifier encryptionAlg) </code><code class="keyword">throws</code><code class="plain"> CertificateEncodingException, CMSException, IOException {</code></div>
<div class="line"><code class="plain">        X500Name name = CertTools.stringToBcX500Name(cacert.getIssuerDN().getName());</code></div>
<div class="line"><code class="plain">        IssuerAndSerialNumber ias = </code><code class="keyword">new</code><code class="plain"> IssuerAndSerialNumber(name, cacert.getSerialNumber());       </code></div>
<div class="line"><code class="plain">        </code><code class="comments">// wrap message in pkcs#7</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> wrap(ias.getEncoded(), Integer.toString(ScepRequestMessage.SCEP_TYPE_GETCRL), transactionId, senderCertificate, signatureKey, encryptionAlg);        </code></div>
<div class="line"><code class="plain">    }</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-85927560_id-.SCEPClientSupportv7.4.0-GeneratingaGetCertInitialMessage">
        <h1 class="heading "><span>Generating a GetCertInitial Message</span></h1>
<p   
>The GetCertInitial message is used when polling EJBCA in RA mode while waiting for issuance of a certificate requiring approval from an administrator.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] generateGetCertInitial(String dn, String transactionId, X509Certificate caCertificate, </code><code class="keyword">final</code><code class="plain"> X509Certificate senderCertificate,</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">final</code><code class="plain"> PrivateKey signatureKey, ASN1ObjectIdentifier encryptionAlg) </code><code class="keyword">throws</code><code class="plain"> CertificateEncodingException, CMSException, IOException {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">this</code><code class="plain">.cacert = caCertificate;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">this</code><code class="plain">.reqdn = dn;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// pkcsGetCertInitial issuerAndSubject ::= { </code></div>
<div class="line"><code class="plain">        </code><code class="comments">//	    issuer "the certificate authority issuer name" </code></div>
<div class="line"><code class="plain">        </code><code class="comments">//	    subject "the requester subject name as given in PKCS#10" </code></div>
<div class="line"><code class="plain">        </code><code class="comments">//	} </code></div>
<div class="line"><code class="plain">        ASN1EncodableVector vec = </code><code class="keyword">new</code><code class="plain"> ASN1EncodableVector();</code></div>
<div class="line"><code class="plain">        vec.add(CertTools.stringToBcX500Name(caCertificate.getIssuerDN().getName()));</code></div>
<div class="line"><code class="plain">        vec.add(CertTools.stringToBcX500Name(dn));</code></div>
<div class="line"><code class="plain">        DERSequence seq = </code><code class="keyword">new</code><code class="plain"> DERSequence(vec);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// wrap message in pkcs#7</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> wrap(seq.getEncoded(), Integer.toString(ScepRequestMessage.SCEP_TYPE_GETCERTINITIAL), transactionId, senderCertificate, signatureKey, encryptionAlg);</code></div>
<div class="line"><code class="plain">    }</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-85927560_id-.SCEPClientSupportv7.4.0-ParsingaSCEPResponse">
        <h1 class="heading "><span>Parsing a SCEP Response</span></h1>
<p   
>The following sample code from EJBCA's protocol tests verifies and extracts the contents of a successful SCEP Response</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">private</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> checkSuccesfulScepResponse(</code><code class="keyword">byte</code><code class="plain">[] retMsg, X509Certificate caCertificate, String userDN, String _senderNonce, String _transId, </code><code class="keyword">boolean</code><code class="plain"> crlRep,</code></div>
<div class="line"><code class="plain">            String digestOid, </code><code class="keyword">boolean</code><code class="plain"> noca, KeyPair keyPair)</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">throws</code><code class="plain"> CMSException, NoSuchProviderException, NoSuchAlgorithmException, CertStoreException, InvalidKeyException, CertificateException,</code></div>
<div class="line"><code class="plain">            SignatureException, CRLException, OperatorCreationException {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Parse response message</code></div>
<div class="line"><code class="plain">        CMSSignedData s = </code><code class="keyword">new</code><code class="plain"> CMSSignedData(retMsg);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// The signer, i.e. the CA, check it's the right CA</code></div>
<div class="line"><code class="plain">        SignerInformationStore signers = s.getSignerInfos();</code></div>
<div class="line"><code class="plain">        Collection&lt;SignerInformation&gt; col = signers.getSigners();</code></div>
<div class="line"><code class="plain">        assertTrue(col.size() &gt; </code><code class="value">0</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        Iterator&lt;SignerInformation&gt; iter = col.iterator();</code></div>
<div class="line"><code class="plain">        SignerInformation signerInfo = iter.next();</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Check that the message is signed with the correct digest alg</code></div>
<div class="line"><code class="plain">        assertEquals(signerInfo.getDigestAlgOID(), digestOid);</code></div>
<div class="line"><code class="plain">        SignerId sinfo = signerInfo.getSID();</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Check that the signer is the expected CA</code></div>
<div class="line"><code class="plain">        assertEquals(CertTools.stringToBCDNString(caCertificate.getIssuerDN().getName()), CertTools.stringToBCDNString(sinfo.getIssuer().toString()));</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Verify the signature</code></div>
<div class="line"><code class="plain">        JcaDigestCalculatorProviderBuilder calculatorProviderBuilder = </code><code class="keyword">new</code><code class="plain"> JcaDigestCalculatorProviderBuilder().setProvider(BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">        JcaSignerInfoVerifierBuilder jcaSignerInfoVerifierBuilder = </code><code class="keyword">new</code><code class="plain"> JcaSignerInfoVerifierBuilder(calculatorProviderBuilder.build()).setProvider(BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">        assertTrue(</code><code class="string">"Response was not correctly signed by CA."</code><code class="plain">, signerInfo.verify(jcaSignerInfoVerifierBuilder.build(caCertificate.getPublicKey())));</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Get authenticated attributes</code></div>
<div class="line"><code class="plain">        AttributeTable tab = signerInfo.getSignedAttributes();</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// --Fail info</code></div>
<div class="line"><code class="plain">        Attribute attr = tab.get(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(ScepRequestMessage.id_failInfo));</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// No failInfo on this success message</code></div>
<div class="line"><code class="plain">        assertNull(attr);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// --Message type</code></div>
<div class="line"><code class="plain">        attr = tab.get(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(ScepRequestMessage.id_messageType));</code></div>
<div class="line"><code class="plain">        assertNotNull(attr);</code></div>
<div class="line"><code class="plain">        ASN1Set values = attr.getAttrValues();</code></div>
<div class="line"><code class="plain">        assertEquals(values.size(), </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        ASN1String str = DERPrintableString.getInstance((values.getObjectAt(</code><code class="value">0</code><code class="plain">)));</code></div>
<div class="line"><code class="plain">        String messageType = str.getString();</code></div>
<div class="line"><code class="plain">        assertEquals(</code><code class="string">"3"</code><code class="plain">, messageType);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// --Success status</code></div>
<div class="line"><code class="plain">        attr = tab.get(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(ScepRequestMessage.id_pkiStatus));</code></div>
<div class="line"><code class="plain">        assertNotNull(attr);</code></div>
<div class="line"><code class="plain">        values = attr.getAttrValues();</code></div>
<div class="line"><code class="plain">        assertEquals(values.size(), </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        str = DERPrintableString.getInstance((values.getObjectAt(</code><code class="value">0</code><code class="plain">)));</code></div>
<div class="line"><code class="plain">        assertEquals(</code><code class="string">"Response status was not as expected."</code><code class="plain">, ResponseStatus.SUCCESS.getStringValue(), str.getString());</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// --SenderNonce</code></div>
<div class="line"><code class="plain">        attr = tab.get(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(ScepRequestMessage.id_senderNonce));</code></div>
<div class="line"><code class="plain">        assertNotNull(attr);</code></div>
<div class="line"><code class="plain">        values = attr.getAttrValues();</code></div>
<div class="line"><code class="plain">        assertEquals(values.size(), </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        ASN1OctetString octstr = ASN1OctetString.getInstance(values.getObjectAt(</code><code class="value">0</code><code class="plain">));</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// SenderNonce is something the server came up with, but it should be 16 chars</code></div>
<div class="line"><code class="plain">        assertEquals(</code><code class="string">"Expected nonce length was 16."</code><code class="plain">, </code><code class="value">16</code><code class="plain">, octstr.getOctets().length);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// --Recipient Nonce</code></div>
<div class="line"><code class="plain">        attr = tab.get(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(ScepRequestMessage.id_recipientNonce));</code></div>
<div class="line"><code class="plain">        assertNotNull(attr);</code></div>
<div class="line"><code class="plain">        values = attr.getAttrValues();</code></div>
<div class="line"><code class="plain">        assertEquals(values.size(), </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        octstr = ASN1OctetString.getInstance(values.getObjectAt(</code><code class="value">0</code><code class="plain">));</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// recipient nonce should be the same as we sent away as sender nonce</code></div>
<div class="line"><code class="plain">        String recipientNonce = </code><code class="keyword">new</code><code class="plain"> String(Base64.encode(octstr.getOctets()));</code></div>
<div class="line"><code class="plain">        assertEquals(</code><code class="string">"Incorrect nonce was received back."</code><code class="plain">, _senderNonce, recipientNonce);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// --Transaction ID</code></div>
<div class="line"><code class="plain">        attr = tab.get(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(ScepRequestMessage.id_transId));</code></div>
<div class="line"><code class="plain">        assertNotNull(attr);</code></div>
<div class="line"><code class="plain">        values = attr.getAttrValues();</code></div>
<div class="line"><code class="plain">        assertEquals(values.size(), </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        str = DERPrintableString.getInstance((values.getObjectAt(</code><code class="value">0</code><code class="plain">)));</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// transid should be the same as the one we sent</code></div>
<div class="line"><code class="plain">        assertEquals(_transId, str.getString());</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// First we extract the encrypted data from the CMS enveloped data contained within the CMS signed data</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">final</code><code class="plain"> CMSProcessable sp = s.getSignedContent();</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] content = (</code><code class="keyword">byte</code><code class="plain">[]) sp.getContent();</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">final</code><code class="plain"> CMSEnvelopedData ed = </code><code class="keyword">new</code><code class="plain"> CMSEnvelopedData(content);</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">final</code><code class="plain"> RecipientInformationStore recipients = ed.getRecipientInfos();</code></div>
<div class="line"><code class="plain">        Store&lt;X509CertificateHolder&gt; certstore;</code></div>
<div class="line"><code class="plain">        Collection&lt;RecipientInformation&gt; c = recipients.getRecipients();</code></div>
<div class="line"><code class="plain">        assertEquals(c.size(), </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        Iterator&lt;RecipientInformation&gt; it = c.iterator();</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">byte</code><code class="plain">[] decBytes = </code><code class="keyword">null</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        RecipientInformation recipient = it.next();</code></div>
<div class="line"><code class="plain">        JceKeyTransEnvelopedRecipient rec = </code><code class="keyword">new</code><code class="plain"> JceKeyTransEnvelopedRecipient(keyPair.getPrivate());</code></div>
<div class="line"><code class="plain">        rec.setProvider(BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">        rec.setContentProvider(BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Option we must set to prevent Java PKCS#11 provider to try to make the symmetric decryption in the HSM,</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// even though we set content provider to BC. Symm decryption in HSM varies between different HSMs and at least for this case is known</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// to not work in SafeNet Luna (JDK behavior changed in JDK 7_75 where they introduced imho a buggy behavior)</code></div>
<div class="line"><code class="plain">        rec.setMustProduceEncodableUnwrappedKey(</code><code class="keyword">true</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        decBytes = recipient.getContent(rec);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// This is yet another CMS signed data</code></div>
<div class="line"><code class="plain">        CMSSignedData sd = </code><code class="keyword">new</code><code class="plain"> CMSSignedData(decBytes);</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Get certificates from the signed data</code></div>
<div class="line"><code class="plain">        certstore = sd.getCertificates();</code></div>
<div class="line"><code class="plain">        assertNotNull(certstore);</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (crlRep) {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// We got a reply with a requested CRL</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">final</code><code class="plain"> List&lt;X509CRLHolder&gt; crls = (List&lt;X509CRLHolder&gt;) sd.getCRLs().getMatches(</code><code class="keyword">null</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            assertEquals(crls.size(), </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// CRL is first (and only)</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">final</code><code class="plain"> X509CRL retCrl = </code><code class="keyword">new</code><code class="plain"> JcaX509CRLConverter().getCRL(crls.get(</code><code class="value">0</code><code class="plain">));</code></div>
<div class="line"><code class="plain">            log.info(</code><code class="string">"Got CRL with DN: "</code><code class="plain"> + retCrl.getIssuerDN().getName());</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// check the returned CRL</code></div>
<div class="line"><code class="plain">            assertEquals(caCertificate.getSubjectDN().getName(), retCrl.getIssuerDN().getName());</code></div>
<div class="line"><code class="plain">            retCrl.verify(caCertificate.getPublicKey());</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// We got a reply with a requested certificate</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">final</code><code class="plain"> Collection&lt;X509CertificateHolder&gt; certs = certstore.getMatches(</code><code class="keyword">null</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// EJBCA returns the issued cert and the CA cert (cisco vpn client requires that the ca cert is included)</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (noca) {</code></div>
<div class="line"><code class="plain">                assertEquals(certs.size(), </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">                assertEquals(certs.size(), </code><code class="value">2</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Issued certificate must be first</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">boolean</code><code class="plain"> verified = </code><code class="keyword">false</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">boolean</code><code class="plain"> gotcacert = </code><code class="keyword">false</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> (X509CertificateHolder x509CertificateHolder : certs) {</code></div>
<div class="line"><code class="plain">                X509Certificate retcert = </code><code class="keyword">new</code><code class="plain"> JcaX509CertificateConverter().getCertificate(x509CertificateHolder);</code></div>
<div class="line"><code class="plain">                log.info(</code><code class="string">"Got cert with DN: "</code><code class="plain"> + retcert.getSubjectDN().getName());</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// check the returned certificate</code></div>
<div class="line"><code class="plain">                String subjectdn = CertTools.getSubjectDN(retcert);</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> (CertTools.stringToBCDNString(userDN).equals(subjectdn)) {</code></div>
<div class="line"><code class="plain">                    </code><code class="comments">// issued certificate</code></div>
<div class="line"><code class="plain">                    assertEquals(CertTools.stringToBCDNString(userDN), subjectdn);</code></div>
<div class="line"><code class="plain">                    assertEquals(CertTools.getSubjectDN(caCertificate), CertTools.getIssuerDN(retcert));</code></div>
<div class="line"><code class="plain">                    retcert.verify(caCertificate.getPublicKey());</code></div>
<div class="line"><code class="plain">                    assertTrue(checkKeys(keyPair.getPrivate(), retcert.getPublicKey()));</code></div>
<div class="line"><code class="plain">                    verified = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">                } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">                    </code><code class="comments">// ca certificate</code></div>
<div class="line"><code class="plain">                    assertEquals(CertTools.getSubjectDN(caCertificate), CertTools.getSubjectDN(retcert));</code></div>
<div class="line"><code class="plain">                    gotcacert = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">            assertTrue(verified);</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (noca) {</code></div>
<div class="line"><code class="plain">                assertFalse(gotcacert);</code></div>
<div class="line"><code class="plain">            } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">                assertTrue(gotcacert);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
</div>
    </div>
<p   
></p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="SCEP_Operations_Guide.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>SCEP Operations Guide</span>
        </a>
                <a href="Modular_Protocol_Configuration.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Modular Protocol Configuration</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
