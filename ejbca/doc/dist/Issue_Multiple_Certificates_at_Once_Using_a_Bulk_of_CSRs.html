<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Issue Multiple Certificates at Once Using a Bulk of CSRs - EJBCA - Documentation Space</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="108530570">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_7.4.3.2_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=93590485"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_7.4.3.2_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="Tutorials_and_Guides.html">Tutorials and Guides</a></li>
                                                                                     <li><a href="Uncommon_CA_Workflows.html">Uncommon CA Workflows</a></li>
                                                            </ul>
</div>            <h1 id="src-93590485"> <span>Issue Multiple Certificates at Once Using a Bulk of CSRs</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>One of the use cases for EJBCA is to create a bulk of certificates, given a bulk of PKCS #10 CSRs. To achieve this, you must integrate with one of EJBCA's APIs for certificate enrollment using a script. This guide uses EJBCA's REST Certificate Management API which allows you to enroll for certificates by sending JSON payloads to EJBCA.</p>
<p   
>Using this guide, you will learn how to do the following:</p>
<ul class=" "><li class=" "><p   
><a   href="#src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step1-ConfigureCAInstance">Step 1 - Configure CA Instance</a>: Issue an RA client keystore and configure access.</p>
</li><li class=" "><p   
><a   href="#src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step2-ConfigureRAInstance">Step 2 - Configure RA Instance</a>: Enable the REST Certificate Management API.</p>
</li><li class=" "><p   
><a   href="#src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step3-ConfigureFileServer">Step 3 - Configure File Server</a>: Create a script for issuing multiple certificates at once using the REST Certificate Management API and set up monitoring of a directory using systemd.</p>
</li><li class=" "><p   
><a   href="#src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step4-TestBulkIssuance">Step 4 - Test Bulk Issuance</a>: Create a PKCS #10 CSR using OpenSSL and test issuance of a certificate to make sure everything is working properly.</p>
</li></ul>    <div class="section section-1" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Architecture">
        <h1 class="heading "><span>Architecture</span></h1>
<p   
>The recommended setup is shown in the figure below.</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/93590485/RA_Setup.png" alt="images/download/attachments/93590485/RA_Setup.png" width="400"  />
    </p>
<p   
>This setup consists of the following components:</p>
<ul class=" "><li class=" "><p   
>A hardware security module storing the private key of the CA.</p>
</li><li class=" "><p   
>An RA instance running EJBCA, acting as a proxy between the file server and the CA.</p>
</li><li class=" "><p   
>A CA instance running EJBCA. The CA is connected to the RA using a peer connector.</p>
</li><li class=" "><p   
>A firewall at the perimeter of the CA security zone shielding the CA from the outside world.</p>
</li><li class=" "><p   
>A Linux file server storing new CSRs and the certificates to be distributed. The file server makes requests to the RA instance using EJBCA's REST Certificate Management API.</p>
</li></ul>    </div>
    <div class="section section-1" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step1-ConfigureCAInstanceStep1-ConfigureCAInstance">
        <h1 class="heading "><span id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step1-ConfigureCAInstance" class="confluence-anchor-link"></span><span>Step 1 - Configure CA Instance </span></h1>
<p   
>Start by configuring the CA instance according to the following instructions.</p>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-IssueRAClientKeystore">
        <h2 class="heading "><span>Issue RA Client Keystore</span></h2>
<p   
>You need to issue an RA client keystore to the file server. The keystore is used by the file server to authenticate to the RA instance when doing REST API calls.</p>
<p   
>Issue the keystore using the following settings:</p>
    <div  class="tablewrap">
        <table class="wrapped confluenceTable">
                    <colgroup>
                                    <col />
                                    <col />
                            </colgroup>
        <thead class=" "></thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Key usage</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Digital signature</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Extended Key Usage</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Client Authentication</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Format</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>P12</p>
            </td>
        </tr>
</tbody>        </table>
            </div>
<p   
>Make a note of the subject DN of the certificate, since it is needed in the next step.</p>
    </div>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-ConfigureRAClientAccess">
        <h2 class="heading "><span>Configure RA Client Access</span></h2>
<p   
>Next, give the RA client certificate access to perform RA functions on the CA. Do this by creating a new role member in EJBCA.</p>
<ol class=" "><li class=" "><p   
>Open the CA Web on the CA instance and click <strong class=" ">Roles and Access Rules</strong>.</p>
</li><li class=" "><p   
>Click <strong class=" ">Add</strong> to add a new role.</p>
</li><li class=" "><p   
>Edit the access rules for the newly created role:</p>
<ol class=" "><li class=" "><p   
>Use <strong class=" ">RA Administrators</strong> as role template, select the appropriate CA and end entity profile.</p>
</li><li class=" "><p   
>Clear <strong class=" ">Approve End Entities</strong>, <strong class=" ">Key Recover End Entities</strong> and <strong class=" ">Revoke End Entities</strong>.</p>
</li><li class=" "><p   
>Clear <strong class=" ">View Audit Log</strong>.</p>
<img  class="confluence-embedded-image"  src="images/download/attachments/93590485/ra_clients.png" alt="images/download/attachments/93590485/ra_clients.png"  height="400" />
    </li></ol></li><li class=" "><p   
>Go to <strong class=" ">Advanced Mode</strong> and set <tt class=" ">/administrator</tt> to allow.</p>
</li><li class=" "><p   
>Add a new role member to this role using the subject DN of the certificate you created in the previous step.</p>
<img  class="confluence-embedded-image"  src="images/download/attachments/93590485/ra_client_members.png" alt="images/download/attachments/93590485/ra_client_members.png" width="600"  />
    </li></ol>    </div>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-AllowRESTAPICallsOverPeers">
        <h2 class="heading "><span>Allow REST API Calls Over Peers</span></h2>
<p   
>Next, configure the role for the peer connector to allow processing of REST API calls.</p>
<ol class=" "><li class=" "><p   
>Click <strong class=" ">Peer Systems</strong> on the menu.</p>
</li><li class=" "><p   
>Click <strong class=" ">Authorized requests</strong> for the peer connector connected to the RA.</p>
</li><li class=" "><p   
>Ensure that access to the appropriate CA and end entity profile is enabled.</p>
</li><li class=" "><p   
>In the     <span style="color: #000000;">
<strong class=" ">Process requests from protocols</strong> section, enable <strong class=" ">REST</strong>.<br/><img  class="confluence-embedded-image"  src="images/download/attachments/93590485/authorized_requests.png" alt="images/download/attachments/93590485/authorized_requests.png" width="400"  />
<br/>    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Click     </span>
<strong class=" ">Roles and Access Rules </strong>on the menu and edit the access rules for the peer connector role used by the RA instance, in advanced mode. Set the access rule <tt class=" ">/administrator</tt> to allow.</p>
</li></ol>    </div>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-ConfigureCertificateProfile">
        <h2 class="heading "><span>Configure Certificate Profile</span></h2>
<p   
>    <span style="color: #000000;">
The only way to provide a subject DN when submitting CSRs using the REST Certificate Management API is to include this information in the CSR. However, apart from the public key, information in the CSR is ignored by default. To use the subject DN of the CSR in the certificate, you need to enable <strong class=" ">Allow Subject DN Override by CSR</strong> in the certificate profile.    </span>
    <span style="color: #000000;">
    </span>
</p>
<ol class=" "><li class=" "><p   
>    <span style="color: #000000;">
Click <strong class=" ">Certificate Profiles</strong> on the menu.    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #000000;">
Edit the appropriate certificate profile and enable <strong class=" ">Allow Subject DN Override by CSR </strong>in the <strong class=" ">Permissions</strong> section.<br/><img  class="confluence-embedded-image"  src="images/download/attachments/93590485/permissions.png" alt="images/download/attachments/93590485/permissions.png"  height="161" />
    </span>
</p>
</li></ol>    </div>
    </div>
    <div class="section section-1" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step2-ConfigureRAInstanceStep2-ConfigureRAInstance">
        <h1 class="heading "><span id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step2-ConfigureRAInstance" class="confluence-anchor-link"></span><span>Step 2 - Configure RA Instance </span></h1>
<p   
>Once the CA instance has been configured, configure the RA instance according to the following instructions.</p>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-EnabletheRESTCertificateManagementAPI">
        <h2 class="heading "><span>Enable the REST Certificate Management API</span></h2>
<p   
>The REST Certificate Management API is disabled by default but can be enabled in the system configuration.</p>
<ol class=" "><li class=" "><p   
>Go to the CA Web on the RA instance and click <strong class=" ">System Configuration</strong> on the menu.</p>
</li><li class=" "><p   
>Click the tab <strong class=" ">Protocol Configuration</strong>.</p>
</li><li class=" "><p   
>Enable <strong class=" ">REST Certificate Management</strong>.</p>
<img  class="confluence-embedded-image"  src="images/download/attachments/93590485/protocol_configuration.png" alt="images/download/attachments/93590485/protocol_configuration.png" width="500"  />
    </li></ol>    </div>
    </div>
    <div class="section section-1" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step3-ConfigureFileServerStep3-ConfigureFileServer">
        <h1 class="heading "><span id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step3-ConfigureFileServer" class="confluence-anchor-link"></span><span>Step 3 - Configure File Server </span></h1>
<p   
>Finally, create the necessary scripts on the file server to do the bulk enrollment.</p>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-InstallDependencies">
        <h2 class="heading "><span>Install Dependencies</span></h2>
<p   
>The following instructions use cURL to do the REST API call, and jq to create JSON payloads.</p>
<p   
>On Debian based distributions, these packages may be installed directly using apt.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Install Dependencies on Debian</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Install Dependencies on Debian" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">apt </code><code class="functions">install</code><code class="plain"> curl jq</code></div>
</div>
    </div>
<p   
>If you are using RHEL 8, you must add the EPEL repository to get access to the <a  class="external-link" href="https://stedolan.github.io/jq/download/">jq package</a>.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Install Dependencies on RHEL</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Install Dependencies on RHEL" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">dnf </code><code class="functions">install</code><code class="plain"> https:</code><code class="plain">//dl</code><code class="plain">.fedoraproject.org</code><code class="plain">/pub/epel/epel-release-latest-8</code><code class="plain">.noarch.rpm</code></div>
<div class="line"><code class="plain">yum </code><code class="functions">install</code><code class="plain"> curl jq</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-CreateNecessaryDirectories">
        <h2 class="heading "><span>Create Necessary Directories</span></h2>
<p   
>Create the following folder structure:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Folder Structure for the RA Plugin</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Folder Structure for the RA Plugin" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">/opt/ejbca-ra-plug/</code></div>
<div class="line"><code class="plain">├── certificates</code></div>
<div class="line"><code class="plain">├── csr</code></div>
<div class="line"><code class="plain">├── failed</code></div>
</div>
    </div>
<p   
>The <tt class=" ">certificates</tt> folder will contain any issued certificates and the <tt class=" ">csr</tt> folder will contain CSRs to be sent to the CA. Once a CSR is processed, it is either removed if the corresponding certificate was issued correctly, or put in the <tt class=" ">failed</tt> folder if the certificate could not be issued for some reason.</p>
    </div>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-TransferKeystoretoFileServer">
        <h2 class="heading "><span>Transfer Keystore to File Server</span></h2>
<p   
>Transfer the keystore <tt class=" ">keystore.p12</tt> you issued previously and place it in the <tt class=" ">/opt/ejbca-ra-plug</tt> directory.</p>
    </div>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-CreateScriptforBulkIssuance">
        <h2 class="heading "><span>Create Script for Bulk Issuance</span></h2>
<p   
>To create the script for the bulk issuance, do the following:</p>
<ol class=" "><li class=" "><p  class="auto-cursor-target" 
>Create the following script:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">/opt/ejbca-ra-plug/ra.sh</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="/opt/ejbca-ra-plug/ra.sh" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="comments">#!/bin/sh</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="functions">hostname</code><code class="plain">=</code></div>
<div class="line"><code class="plain">port=</code></div>
<div class="line"><code class="plain">client_cert=</code><code class="string">"/opt/ejbca-ra-plug/keystore.p12:foo123"</code></div>
<div class="line"><code class="plain">cert_profile_name=</code></div>
<div class="line"><code class="plain">ee_profile_name=</code></div>
<div class="line"><code class="plain">ca_name=</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">while</code><code class="plain"> [ </code><code class="string">"$(ls -A /opt/ejbca-ra-plug/csr)"</code><code class="plain"> ]; </code><code class="keyword">do</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> </code><code class="functions">file</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> </code><code class="plain">/opt/ejbca-ra-plug/csr/</code><code class="plain">*.csr; </code><code class="keyword">do</code></div>
<div class="line"><code class="plain">        [ -e </code><code class="string">"$file"</code><code class="plain"> ] || </code><code class="keyword">continue</code></div>
<div class="line"><code class="plain">        </code><code class="comments"># Use the CN in the CSR as the username of the end entity</code></div>
<div class="line"><code class="plain">        username=$(openssl req -</code><code class="keyword">in</code><code class="plain"> ${</code><code class="functions">file</code><code class="plain">} -inform PEM -noout -subject -nameopt multiline | </code><code class="functions">sed</code><code class="plain"> -n </code><code class="string">'s/ *commonName *= //p'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        password=</code><code class="string">"foo123"</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">        csr=$(</code><code class="functions">cat</code><code class="plain"> ${</code><code class="functions">file</code><code class="plain">})</code></div>
<div class="line"><code class="plain">        template=</code><code class="string">'{"certificate_request":$csr, "certificate_profile_name":$cp, "end_entity_profile_name":$eep, "certificate_authority_name":$ca, "username":$ee, "password":$password}'</code></div>
<div class="line"><code class="plain">        json_payload=$(jq -n \</code></div>
<div class="line"><code class="plain">            --arg csr </code><code class="string">"$csr"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            --arg </code><code class="functions">cp</code><code class="plain"> </code><code class="string">"$cert_profile_name"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            --arg eep </code><code class="string">"$ee_profile_name"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            --arg ca </code><code class="string">"$ca_name"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            --arg ee </code><code class="string">"$username"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            --arg password </code><code class="string">"$password"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            </code><code class="string">"$template"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        http_code=$(curl -X POST -s \</code></div>
<div class="line"><code class="plain">            -o </code><code class="string">'/tmp/response.json'</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            -w </code><code class="string">'%{http_code}'</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            --cert-</code><code class="functions">type</code><code class="plain"> P12 \</code></div>
<div class="line"><code class="plain">            --cert </code><code class="string">"$client_cert"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            -H </code><code class="string">'Content-Type: application/json'</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            --data </code><code class="string">"$json_payload"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">            </code><code class="string">"https://$hostname:$port/ejbca/ejbca-rest-api/v1/certificate/pkcs10enroll"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        exit_code=</code><code class="string">"$?"</code></div>
<div class="line"><code class="plain">        </code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> [ </code><code class="string">"$exit_code"</code><code class="plain"> -</code><code class="keyword">ne</code><code class="plain"> 0 ]; </code><code class="keyword">then</code></div>
<div class="line"><code class="plain">            logger </code><code class="string">"Failed to issue certificate for '$username'. cURL exited with exit code $exit_code."</code></div>
<div class="line"><code class="plain">            </code><code class="functions">mv</code><code class="plain"> </code><code class="string">"$file"</code><code class="plain"> </code><code class="plain">/opt/ejbca-ra-plug/failed/</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">continue</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">fi</code></div>
<div class="line"><code class="plain">        response=$(</code><code class="functions">cat</code><code class="plain"> </code><code class="string">'/tmp/response.json'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> [ </code><code class="string">"$http_code"</code><code class="plain"> -</code><code class="keyword">ne</code><code class="plain"> </code><code class="string">'201'</code><code class="plain"> ]; </code><code class="keyword">then</code></div>
<div class="line"><code class="plain">            logger </code><code class="string">"Failed to issue certificate for '$username'. Server returned HTTP status code $http_code."</code></div>
<div class="line"><code class="plain">            logger </code><code class="string">"Response from server: $response"</code></div>
<div class="line"><code class="plain">            </code><code class="functions">mv</code><code class="plain"> </code><code class="string">"$file"</code><code class="plain"> </code><code class="plain">/opt/ejbca-ra-plug/failed/</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">continue</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">fi</code></div>
<div class="line"><code class="plain">        certificate=$(</code><code class="functions">cat</code><code class="plain"> </code><code class="string">'/tmp/response.json'</code><code class="plain"> | jq -r .certificate)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> [ </code><code class="string">"$certificate"</code><code class="plain"> = </code><code class="string">'null'</code><code class="plain"> ]; </code><code class="keyword">then</code></div>
<div class="line"><code class="plain">            logger </code><code class="string">"Failed to issue certificate for '$username'. No certificate found in response."</code><code class="plain">      </code></div>
<div class="line"><code class="plain">            logger </code><code class="string">"Response from server: $response"</code></div>
<div class="line"><code class="plain">            </code><code class="functions">mv</code><code class="plain"> </code><code class="string">"$file"</code><code class="plain"> </code><code class="plain">/opt/ejbca-ra-plug/failed/</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">continue</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">fi</code></div>
<div class="line"><code class="plain">        filename=$(</code><code class="functions">basename</code><code class="plain"> </code><code class="string">"$file"</code><code class="plain"> .csr)</code></div>
<div class="line"><code class="plain">        </code><code class="functions">echo</code><code class="plain"> </code><code class="string">'-----BEGIN CERTIFICATE-----'</code><code class="plain"> &gt; </code><code class="string">"/opt/ejbca-ra-plug/certificates/$filename.pem"</code></div>
<div class="line"><code class="plain">        </code><code class="functions">echo</code><code class="plain"> </code><code class="string">"$certificate"</code><code class="plain"> &gt;&gt; </code><code class="string">"/opt/ejbca-ra-plug/certificates/$filename.pem"</code></div>
<div class="line"><code class="plain">        </code><code class="functions">echo</code><code class="plain"> </code><code class="string">'-----END CERTIFICATE-----'</code><code class="plain"> &gt;&gt; </code><code class="string">"/opt/ejbca-ra-plug/certificates/$filename.pem"</code></div>
<div class="line"><code class="plain">        </code><code class="functions">rm</code><code class="plain"> </code><code class="string">"$file"</code></div>
<div class="line"><code class="plain">        logger </code><code class="string">"Succesfully issued certificate for '$username'."</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">done</code></div>
<div class="line"><code class="keyword">done</code><code class="plain">⏎  </code></div>
</div>
    </div>
</li><li class=" "><p  class="auto-cursor-target" 
>Set the hostname, the port, the password of the keystore, the name of the end entity and certificate profile, and the name of the CA signing the certificate.</p>
</li><li class=" "><p  class="auto-cursor-target" 
>Ensure the file is executable and only readable by <tt class=" ">root</tt>.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Set permissions for ra.sh</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Set permissions for ra.sh" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="functions">chmod</code><code class="plain"> 700 </code><code class="plain">/opt/ejbca-ra-plug/ra</code><code class="plain">.sh</code></div>
</div>
    </div>
</li></ol>    </div>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-SetUpMonitoringusingSystemd">
        <h2 class="heading "><span>Set Up Monitoring using Systemd</span></h2>
<p   
>Next, set up monitoring of the CSR directory in order to issue a new certificate automatically every time you drop a CSR in the<tt class=" ">/opt/ejbca-ra-plug/csr</tt> directory.</p>
<p   
>To monitor the directory using <tt class=" ">systemd,</tt> do the following:</p>
<ol class=" "><li class=" "><p  class="auto-cursor-target" 
>Create the systemd monitoring script.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">/etc/systemd/system/ra.path</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="/etc/systemd/system/ra.path" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">[Unit]</code></div>
<div class="line"><code class="plain">Description=EJBCA RA Plug</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[Path]</code></div>
<div class="line"><code class="plain">DirectoryNotEmpty=</code><code class="plain">/opt/ejbca-ra-plug/csr</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[Install]</code></div>
<div class="line"><code class="plain">WantedBy=multi-user.target</code></div>
</div>
    </div>
</li><li class=" "><p  class="auto-cursor-target" 
>Create the systemd service file.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">/etc/systemd/system/ra.service</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="/etc/systemd/system/ra.service" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">[Unit]</code></div>
<div class="line"><code class="plain">Description=EJBCA RA Service</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[Install]</code></div>
<div class="line"><code class="plain">WantedBy=multi-user.target</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[Service]</code></div>
<div class="line"><code class="plain">Type=oneshot</code></div>
<div class="line"><code class="plain">ExecStart=</code><code class="plain">/opt/ejbca-ra-plug/ra</code><code class="plain">.sh</code></div>
</div>
    </div>
</li><li class=" "><p  class="auto-cursor-target" 
>Start monitoring.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">systemctl daemon-reload</code></div>
<div class="line"><code class="plain">systemctl enable ra.path --now</code></div>
</div>
    </div>
</li></ol>    </div>
    </div>
    <div class="section section-1" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step4-TestBulkIssuanceStep4-TestBulkIssuance">
        <h1 class="heading "><span id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Step4-TestBulkIssuance" class="confluence-anchor-link"></span><span>Step 4 - Test Bulk Issuance </span></h1>
<p   
>To test the bulk issuance, do the following:</p>
<ol class=" "><li class=" "><p  class="auto-cursor-target" 
>To test your script, create a key and CSR using OpenSSL.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Create a CSR using OpenSSL</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Create a CSR using OpenSSL" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">openssl req -nodes -newkey rsa:2048 -keyout </code><code class="functions">test</code><code class="plain">.key -out </code><code class="functions">test</code><code class="plain">.csr -subj </code><code class="string">"/C=SE/O=PrimeKey Solutions AB/CN=Bulk Issuance Test"</code></div>
</div>
    </div>
</li><li class=" "><p  class="auto-cursor-target" 
>Move the CSR to the <tt class=" ">/opt/ejbca-ra-plug/csr</tt> directory.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Move the CSR</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Move the CSR" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="functions">mv</code><code class="plain"> </code><code class="functions">test</code><code class="plain">.csr </code><code class="plain">/opt/ejbca-ra-plug/csr/</code></div>
</div>
    </div>
</li><li class=" "><p   
>The certificate should now be available in the <tt class=" ">/opt/ejbca-ra-plug/certificates</tt> directory.</p>
</li></ol>    </div>
    <div class="section section-1" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-Troubleshooting">
        <h1 class="heading "><span>Troubleshooting</span></h1>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-ChecktheSyslog">
        <h2 class="heading "><span>Check the Syslog</span></h2>
<p   
>    <span style="color: #000000;">
Errors are written to syslog.    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&gt; journalctl -xe</code></div>
<div class="line"><code class="plain">-- Unit ra.service has begun starting up.</code></div>
<div class="line"><code class="plain">Nov 23 20:43:04 rhel8 root[2657]: Failed to issue certificate </code><code class="keyword">for</code><code class="plain"> </code><code class="string">'Bulk Issuance Test'</code><code class="plain">. cURL exited with </code><code class="functions">exit</code><code class="plain"> code 60.</code></div>
<div class="line"><code class="plain">Nov 23 20:43:04 rhel8 systemd[1]: Started EJBCA RA Service.</code></div>
<div class="line"><code class="plain">-- Subject: Unit ra.service has finished start-up</code></div>
<div class="line"><code class="plain">-- Defined-By: systemd</code></div>
<div class="line"><code class="plain">-- Support: https:</code><code class="plain">//access</code><code class="plain">.redhat.com</code><code class="plain">/support</code></div>
<div class="line"><code class="plain">-- </code></div>
<div class="line"><code class="plain">-- Unit ra.service has finished starting up.</code></div>
</div>
    </div>
<p   
>In this example, <a  class="external-link" href="https://curl.haxx.se/libcurl/c/libcurl-errors.html">cURL failed with exit code 60</a>, which means that the TLS server certificate of the RA instance is untrusted. If you encounter this problem, import the issuer into the file server's truststore.</p>
    </div>
    <div class="section section-2" id="src-93590485_id-.IssueMultipleCertificatesatOnceUsingaBulkofCSRsv7.4.3-EnableVerboseLoggingincURL">
        <h2 class="heading "><span>Enable Verbose Logging in cURL</span></h2>
<p   
>You can run cURL with<tt class=" ">-v</tt> for more verbose logging.</p>
    </div>
    <div class="section section-2" id="src-93590485_safe-id-aWQtLklzc3VlTXVsdGlwbGVDZXJ0aWZpY2F0ZXNhdE9uY2VVc2luZ2FCdWxrb2ZDU1JzdjcuNC4zLVVzZVBFTUZpbGVzSW5zdGVhZG9mUEtDUyMxMg">
        <h2 class="heading "><span>Use PEM Files Instead of PKCS #12</span></h2>
<p   
>Some older versions of cURL do not support PKCS #12 files. In that case, you may split the PKCS #12 file into a client certificate, CA certificate and private key.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Split PKCS #12 file using OpenSSL</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Split PKCS #12 file using OpenSSL" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">openssl pkcs12 -</code><code class="keyword">in</code><code class="plain"> </code><code class="plain">/opt/ejbca-ra-plug/keystore</code><code class="plain">.p12 -out </code><code class="plain">/opt/ejbca-ra-plug/ca</code><code class="plain">.pem -cacerts -nokeys</code></div>
<div class="line"><code class="plain">openssl pkcs12 -</code><code class="keyword">in</code><code class="plain"> </code><code class="plain">/opt/ejbca-ra-plug/keystore</code><code class="plain">.p12 -out </code><code class="plain">/opt/ejbca-ra-plug/cert</code><code class="plain">.pem -clcerts -nokeys</code></div>
<div class="line"><code class="plain">openssl pkcs12 -</code><code class="keyword">in</code><code class="plain"> </code><code class="plain">/opt/ejbca-ra-plug/keystore</code><code class="plain">.p12 -out </code><code class="plain">/opt/ejbca-ra-plug/key</code><code class="plain">.pem.tmp -nocerts</code></div>
<div class="line"><code class="plain">openssl pkcs8 -</code><code class="keyword">in</code><code class="plain"> </code><code class="plain">/opt/ejbca-ra-plug/key</code><code class="plain">.pem.tmp -out </code><code class="plain">/opt/ejbca-ra-plug/key</code><code class="plain">.pem</code></div>
<div class="line"><code class="functions">rm</code><code class="plain"> -f </code><code class="plain">/opt/ejbca-ra-plug/key</code><code class="plain">.pem.tmp</code></div>
</div>
    </div>
<p   
>Then specify these files when you run cURL:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">pem_password=</code></div>
<div class="line"><code class="plain">curl -X POST -s \</code></div>
<div class="line"><code class="plain">    -o </code><code class="string">'/tmp/response.json'</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">    -w </code><code class="string">'%{http_code}'</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">    --cacert </code><code class="string">'/opt/ejbca-ra-plug/ca.pem'</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">    --key </code><code class="string">'/opt/ejbca-ra-plug/key.pem'</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">    --cert </code><code class="string">"/opt/ejbca-ra-plug/cert.pem:$pem_password"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">    -H </code><code class="string">'Content-Type: application/json'</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">    --data </code><code class="string">"$json_payload"</code><code class="plain"> \</code></div>
<div class="line"><code class="plain">    "https:</code><code class="plain">//</code><code class="plain">$</code><code class="functions">hostname</code><code class="plain">/ejbca/ejbca-rest-api/v1/certificate/pkcs10enroll</code></div>
</div>
    </div>
    </div>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Change_Signing_Algorithm_on_Root_CA%27s_Certificates.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Change Signing Algorithm on Root CA's Certificates</span>
        </a>
                <a href="Batch_Creating_Certificates.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Batch Creating Certificates</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
