<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Generic PKCS#11 Provider - EJBCA - Documentation Space</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="108530570">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_7.4.3.2_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=85933181"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_7.4.3.2_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Integration.html">EJBCA Integration</a></li>
                                                                                     <li><a href="Hardware_Security_Modules_%28HSM%29.html">Hardware Security Modules (HSM)</a></li>
                                                            </ul>
</div>            <h1 id="src-85933181"> <span>Generic PKCS#11 Provider</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>A PKCS#11 wrapper has been used to implement support for tokens with PKCS#11 libraries. The PKCS#11 provider has at some stage been tested with HSMs described here, in various firmware and software versions (as well as some that are not described). For information on support for specific versions, consult support or other documentation.</p>
<p   
>Besides the keys described in <a   href="Hardware_Security_Modules_%28HSM%29.html">Hardware Security Modules (HSM)</a>, the Crypto Token property field (matching with user friendly values of the Crypto Token in the Administration GUI) should contain the following properties:</p>
<ul class=" "><li class=" "><p   
>sharedLibrary: Path to the HSM PKCS#11 library (/etc/utimaco/libcs2_pkcs11.so, /usr/safenet/lunaclient/lib/libCryptoki2_64.so etc)</p>
</li><li class=" "><p   
>slotLabelType: Type of slot reference, see below</p>
</li><li class=" "><p   
>slotLabelValue: Value of the slot reference (1, myslot etc).</p>
</li></ul><p   
>The slot label type can be one of the following</p>
<ul class=" "><li class=" "><p   
>SLOT_NUMBER: Any positive integer, can be used to refer to slots in any HSM with consecutive slot numbering.</p>
</li><li class=" "><p   
>SLOT_INDEX: Any positive integer, prefaced by an 'i'.</p>
</li><li class=" "><p   
>SLOT_LABEL: The PKCS#11 standard allows for using strings for labeling slots. This label may also be an integer or an 'i' followed by an integer (like a number or an index)</p>
</li><li class=" "><p   
>SUN_FILE: The slot specified by a SUN config file. The slot label can be left blank.</p>
</li></ul><p   
>Optionally a few extra properties fields can be used:</p>
<ul class=" "><li class=" "><p   
>attributesFile: A file specifying PKCS#11 attributes (used mainly for key generation).</p>
</li><li class=" "><p   
>keyspec: Key specification used when generating new HSM keys from within the admin GUI. Keyspec that is used as first choice when generating new keys in the GUI of form &quot;1024&quot; for RSA keys, &quot;DSA1024&quot; for DSA keys and secp256r1 for EC keys. If keyspec is not given EJBCA tries to generate a key with the same specification as the current cert signing key.</p>
</li></ul><p   
>An attributes file is in the format specified in the <a  class="external-link" href="http://download.oracle.com/javase/7/docs/technotes/guides/security/p11guide.html">JavaTM PKCS#11 Reference Guide</a>.</p>
<p   
>If no attributesFile is specified, a built-in default configuration is used (as of EJBCA 3.11). Generally, you should NOT use an <strong class=" ">attributesFile</strong> and thus only in exceptional cases using an uncommon HSM not working well with the defaults.</p>
<p   
>The following shows an example of an 'attributesFile' (that should not be used) which will give generated keys same attribute values as the default:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">name=SafeNet</code></div>
<div class="line"><code class="plain">library=</code><code class="plain">/opt/PTK/lib/libcryptoki</code><code class="plain">.so</code></div>
<div class="line"><code class="plain">slot=1</code></div>
<div class="line"><code class="plain">attributes(*, CKO_PUBLIC_KEY, *) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = </code><code class="functions">false</code></div>
<div class="line"><code class="plain">  CKA_ENCRYPT = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_VERIFY = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_WRAP = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">attributes(*, CKO_PRIVATE_KEY, *) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_PRIVATE = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_SENSITIVE = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_EXTRACTABLE = </code><code class="functions">false</code></div>
<div class="line"><code class="plain">  CKA_DECRYPT = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_SIGN = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_UNWRAP = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_DERIVE = </code><code class="functions">false</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">disabledMechanisms = {</code></div>
<div class="line"><code class="plain">  CKM_SHA1_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA256_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA384_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA512_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_MD2_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_MD5_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_DSA_SHA1</code></div>
<div class="line"><code class="plain">  CKM_ECDSA_SHA1</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>The only known occasion where the default is not working is when the module protected slot of a Thales/nCipher HSM is used and the file must then exist and have <strong class=" ">CKA_PRIVATE = false</strong> (see below).</p>
<p   
>The default attributes that are applied to each key generated by EJBCA will assure that:</p>
<ul class=" "><li class=" "><p   
>All needed operations could be done.</p>
</li><li class=" "><p   
>The private part of the key is stored in the HSM but not the public part (which is in a certificate that is stored on the HSM).</p>
</li><li class=" "><p   
>It will be impossible to read the private part of the key from the HSM.</p>
</li></ul><p   
>The default configuration will also disable certain signing mechanisms. The disabled mechanisms are for signing when the data to be signed is hashed by PKCS#11 before using the private key in the HSM. When these mechanisms are disabled, the sun PKCS#11 wrapper provider will do the hashing instead of the HSM. This speeds up the signing in most cases, especially when your HSM is on another host and will not have any security impacts as no secret in the HSM is used for the hashing.</p>
<p   
>However, it will be possible not to disable these hash/signing mechanisms, see the PKCS#11 section of '$EJBCA_HOME/conf/cesecore.properties'. You could try not to disable the mechanisms if you get the error CKR_FUNCTION_NOT_SUPPORTED (0x54) from PKCS#11 when signing.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>If you are using an attributesFile and have more than one CA using the same slot it is very important that BOTH CA token properties configurations contain the attributesFile. This is because the attributes are applied when the provider is installed during startup. If one configuration does not have the attributesFile it cannot be applied later on by the other configuration.</p>
        </div>
    </div>
<p   
>The tool <strong class=" ">EJBCA_HOME/dist/clientToolBox/ejbcaClientToolBox.sh PKCS11HSMKeyTool</strong> is used to administrate and generate keys. Use it without parameters to get all valid options. Keys are generated either using a default specified slot and PKCS#11 library or using a configuration file.</p>
<ul class=" "><li class=" "><p   
>To generate keys using the built-in default with a specified slot and PKCS#11 library, use:</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">dist</code><code class="plain">/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate hsmp11.so 2048 defaultKey 1</code></div>
</div>
    </div>
<ul class=" "><li class=" "><p   
>To generate keys using a configuration file, use:</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">dist</code><code class="plain">/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate hsmp11.conf 2048 defaultKey</code></div>
</div>
    </div>
<p   
>The contents of the configuration file is specified in the PKCS#11 wrapper documentation from Oracle. Generally, it is sufficient to use the default but with some HSMs, it may be necessary to define certain PKCS#11 attributes for the generated key.</p>
<p   
>Note that all keys to be used have to be generated prior to the application server is started.</p>
<p   
>The default attributes attempt to automatically set CKA_LABEL also when generating keys using the clientToolBox. You can set CKA_LABEL, which is hex encoded characters, also with an attributesFile, either by setting the CKA_LABEL value:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">attributes(*, CKO_PRIVATE_KEY, *) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = </code><code class="keyword">true</code></div>
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain">  CKA_LABEL = 0h707269762d6b65796c6162656c</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>or by setting an empty CKA_LABEL string with two spaces before and nothing, not even space after. This placeholder will then be dynamically replaced with the key alias value, hex encoded:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">attributes(*, CKO_PRIVATE_KEY, *) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = </code><code class="keyword">true</code></div>
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain">  CKA_LABEL</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <div class="section section-1" id="src-85933181_id-.GenericPKCS11Providerv7.4.0-GeneratedHSMObjectsGenerated_HSM_objects">
        <h1 class="heading "><span id="src-85933181_id-.GenericPKCS11Providerv7.4.0-Generated_HSM_objects" class="confluence-anchor-link"></span><span>Generated HSM Objects </span></h1>
<p   
>EJBCA needs (via the Java PKCS#11 provider) two object on the HSM, which are all generated by the generate commands above:</p>
<ul class=" "><li class=" "><p   
>A private key</p>
</li><li class=" "><p   
>A certificate, thus a holder of the public key used by Java, and not the real certificate of a CA.</p>
</li></ul>    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>A Java keystore entry has no reference to a public key pkcs#11 object, just a private key object and a certificate object, hence the public key object is not needed after the certificate object has been written to the keystore. By setting the CKA_TOKEN attribute to false for the public key its object will not be stored on the HSM. If CKA_TOKEN is true then all public keys will be on the HSM forever since no public key is deleted when a private key is deleted from the keystore. So in order not to waste memory on the HSM CKA_TOKEN must be false for the public key.</p>
        </div>
    </div>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>When generating keys with clientToolBox each private key has the CKA_LABEL attribute set to the <strong class=" ">alias</strong> of the key prefixed with <strong class=" ">priv-</strong>. But when generating a key in EJBCA there will normally not be a CKA_LABEL for the private key. If you want to have a label even when the key is generated by EJBCA you got to use an attribute file with a CKA_LABEL definition in your configuration. The value of the attribute is a hexadecimal string starting with &quot;0h&quot;. These labels are normally seen only when you use the native HSM tools to list and manipulate objects. CKA_LABEL is set on the certificate object, and this is the label used as an alias in Java/EJBCA. The PKCS#11 attribute CKA_ID binds a certificate object (public key) to the private key.</p>
        </div>
    </div>
<p   
>The above example would then include:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">attributes(*,CKO_PRIVATE_KEY,*) = {</code></div>
<div class="line"><code class="plain">  .</code></div>
<div class="line"><code class="plain">  .</code></div>
<div class="line"><code class="plain">  CKA_LABEL = 0h6b657931</code></div>
<div class="line"><code class="plain">} </code></div>
</div>
    </div>
<p   
>The example above gives the label <strong class=" ">key1</strong> to the private key. You can give any label by looking up the hex codes of characters in the ascii table.</p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Hardware_Security_Modules_%28HSM%29.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Hardware Security Modules (HSM)</span>
        </a>
                <a href="AEP_Keyper.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>AEP Keyper</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
