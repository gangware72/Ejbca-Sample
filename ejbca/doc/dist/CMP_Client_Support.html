<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CMP Client Support - EJBCA - Documentation Space</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="108530570">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_7.4.3.2_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=85927124"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_7.4.3.2_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations.html">EJBCA Operations</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations_Guide.html">EJBCA Operations Guide</a></li>
                                                                                                         <li class="shortcut"><a href="CA_Operations_Guide.html">CA Operations Guide</a></li>
                                                                                                         <li class="shortcut"><a href="Enrollment_Protocol_Configuration.html">Enrollment Protocol Configuration</a></li>
                                                                                     <li><a href="CMP_Operations_Guide.html">CMP Operations Guide</a></li>
                                                            </ul>
</div>            <h1 id="src-85927124"> <span>CMP Client Support</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>This page provides some code sample and other information required when creating a CMP client. These code sample are not maintained, and may not be in accordance with future versions of BouncyCastle.</p>
        </div>
    </div>
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-85927124_safe-id-aWQtLkNNUENsaWVudFN1cHBvcnR2Ny40LjAtSE1BQ3Byb3RlY3RlZChSQW1vZGUpY2VydGlmaWNhdGVyZXF1ZXN0KGluaXRpYWwpbWVzc2FnZQ">HMAC protected (RA mode) certificate request (initial) message</a></p>
</li><li class=" "><p   
><a   href="#src-85927124_safe-id-aWQtLkNNUENsaWVudFN1cHBvcnR2Ny40LjAtSE1BQ3Byb3RlY3RlZChSQW1vZGUpcmV2b2NhdGlvbnJlcXVlc3RtZXNzYWdl">HMAC protected (RA mode) revocation request message</a></p>
</li><li class=" "><p   
><a   href="#src-85927124_safe-id-aWQtLkNNUENsaWVudFN1cHBvcnR2Ny40LjAtU2lnbmF0dXJlcHJvdGVjdGVkKENsaWVudG1vZGUpbWVzc2FnZQ">Signature protected (Client mode) message</a></p>
</li><li class=" "><p   
><a   href="#src-85927124_id-.CMPClientSupportv7.4.0-MessagewithMultipleSignatures">Message with Multiple Signatures</a></p>
</li></ul>    <div class="section section-1" id="src-85927124_safe-id-aWQtLkNNUENsaWVudFN1cHBvcnR2Ny40LjAtSE1BQ3Byb3RlY3RlZChSQW1vZGUpY2VydGlmaWNhdGVyZXF1ZXN0KGluaXRpYWwpbWVzc2FnZQ">
        <h1 class="heading "><span>HMAC protected (RA mode) certificate request (initial) message</span></h1>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="eclipse syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="comments">// Just preparations</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> BigInteger certReqId = BigInteger.valueOf(</code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] senderNonce = </code><code class="string">"12345"</code><code class="plain">.getBytes();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] transactionId = </code><code class="string">"23456"</code><code class="plain">.getBytes();</code></div>
<div class="line"><code class="plain">KeyPairGenerator kpi = KeyPairGenerator.getInstance(</code><code class="string">"RSA"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">kpi.initialize(</code><code class="value">1024</code><code class="plain">);</code></div>
<div class="line"><code class="plain">KeyPair keyPair = kpi.generateKeyPair();</code></div>
<div class="line"><code class="comments">// Now on to the CMP </code></div>
<div class="line"><code class="plain">CertificateRequestMessageBuilder msgbuilder = </code><code class="keyword">new</code><code class="plain"> CertificateRequestMessageBuilder(certReqId);</code></div>
<div class="line"><code class="plain">X500Name issuerDN = </code><code class="keyword">new</code><code class="plain"> X500Name(</code><code class="string">"CN=ManagementCA"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">X500Name subjectDN = </code><code class="keyword">new</code><code class="plain"> X500Name(</code><code class="string">"CN=user"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">msgbuilder.setIssuer(issuerDN);</code></div>
<div class="line"><code class="plain">msgbuilder.setSubject(subjectDN);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[]                  bytes = keyPair.getPublic().getEncoded();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> ByteArrayInputStream    bIn = </code><code class="keyword">new</code><code class="plain"> ByteArrayInputStream(bytes);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> ASN1InputStream         dIn = </code><code class="keyword">new</code><code class="plain"> ASN1InputStream(bIn);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> SubjectPublicKeyInfo keyInfo = </code><code class="keyword">new</code><code class="plain"> SubjectPublicKeyInfo((ASN1Sequence)dIn.readObject());</code></div>
<div class="line"><code class="plain">dIn.close();</code></div>
<div class="line"><code class="plain">msgbuilder.setPublicKey(keyInfo);</code></div>
<div class="line"><code class="plain">GeneralName sender = </code><code class="keyword">new</code><code class="plain"> GeneralName(subjectDN);</code></div>
<div class="line"><code class="plain">msgbuilder.setAuthInfoSender(sender);</code></div>
<div class="line"><code class="comments">// RAVerified POP</code></div>
<div class="line"><code class="plain">msgbuilder.setProofOfPossessionRaVerified();</code></div>
<div class="line"><code class="plain">CertificateRequestMessage msg = msgbuilder.build();</code></div>
<div class="line"><code class="plain">org.bouncycastle.asn1.crmf.CertReqMessages msgs = </code><code class="keyword">new</code><code class="plain"> org.bouncycastle.asn1.crmf.CertReqMessages(msg.toASN1Structure());</code></div>
<div class="line"><code class="plain">org.bouncycastle.asn1.cmp.PKIBody pkibody = </code><code class="keyword">new</code><code class="plain"> org.bouncycastle.asn1.cmp.PKIBody(org.bouncycastle.asn1.cmp.PKIBody.TYPE_INIT_REQ, msgs);</code></div>
<div class="line"><code class="comments">// Message protection and final message</code></div>
<div class="line"><code class="plain">GeneralName recipient = </code><code class="keyword">new</code><code class="plain"> GeneralName(issuerDN);</code></div>
<div class="line"><code class="plain">ProtectedPKIMessageBuilder pbuilder = </code><code class="keyword">new</code><code class="plain"> ProtectedPKIMessageBuilder(sender, recipient);</code></div>
<div class="line"><code class="plain">pbuilder.setMessageTime(</code><code class="keyword">new</code><code class="plain"> Date());</code></div>
<div class="line"><code class="comments">// senderNonce</code></div>
<div class="line"><code class="plain">pbuilder.setSenderNonce(senderNonce);</code></div>
<div class="line"><code class="comments">// TransactionId</code></div>
<div class="line"><code class="plain">pbuilder.setTransactionID(transactionId);</code></div>
<div class="line"><code class="comments">// Key Id used (required) by the recipient to do a lot of stuff</code></div>
<div class="line"><code class="plain">pbuilder.setSenderKID(</code><code class="string">"KeyID"</code><code class="plain">.getBytes());</code></div>
<div class="line"><code class="plain">pbuilder.setBody(pkibody);</code></div>
<div class="line"><code class="plain">JcePKMACValuesCalculator jcePkmacCalc = </code><code class="keyword">new</code><code class="plain"> JcePKMACValuesCalculator();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> AlgorithmIdentifier digAlg = </code><code class="keyword">new</code><code class="plain"> AlgorithmIdentifier(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(</code><code class="string">"1.3.14.3.2.26"</code><code class="plain">)); </code><code class="comments">// SHA1</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> AlgorithmIdentifier macAlg = </code><code class="keyword">new</code><code class="plain"> AlgorithmIdentifier(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(</code><code class="string">"1.2.840.113549.2.7"</code><code class="plain">)); </code><code class="comments">// HMAC/SHA1</code></div>
<div class="line"><code class="plain">jcePkmacCalc.setup(digAlg, macAlg);</code></div>
<div class="line"><code class="plain">PKMACBuilder macbuilder = </code><code class="keyword">new</code><code class="plain"> PKMACBuilder(jcePkmacCalc);</code></div>
<div class="line"><code class="plain">MacCalculator macCalculator = macbuilder.build(</code><code class="string">"password"</code><code class="plain">.toCharArray());</code></div>
<div class="line"><code class="plain">ProtectedPKIMessage message = pbuilder.build(macCalculator);</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-85927124_safe-id-aWQtLkNNUENsaWVudFN1cHBvcnR2Ny40LjAtSE1BQ3Byb3RlY3RlZChSQW1vZGUpcmV2b2NhdGlvbnJlcXVlc3RtZXNzYWdl">
        <h1 class="heading "><span>HMAC protected (RA mode) revocation request message</span></h1>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="eclipse syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="comments">// Just preparations</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] senderNonce = </code><code class="string">"12345"</code><code class="plain">.getBytes();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] transactionId = </code><code class="string">"23456"</code><code class="plain">.getBytes();</code></div>
<div class="line"><code class="plain">BigInteger serNo = </code><code class="keyword">new</code><code class="plain"> BigInteger(</code><code class="string">"aabbccdd"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">X500Name issuerDN = </code><code class="keyword">new</code><code class="plain"> X500Name(</code><code class="string">"CN=ManagementCA"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">X500Name userDN = </code><code class="keyword">new</code><code class="plain"> X500Name(</code><code class="string">"CN=user"</code><code class="plain">);</code></div>
<div class="line"><code class="comments">// Cert template too tell which cert we want to revoke</code></div>
<div class="line"><code class="plain">CertTemplateBuilder myCertTemplate = </code><code class="keyword">new</code><code class="plain"> CertTemplateBuilder();</code></div>
<div class="line"><code class="plain">myCertTemplate.setIssuer(issuerDN);</code></div>
<div class="line"><code class="plain">myCertTemplate.setSubject(userDN);</code></div>
<div class="line"><code class="plain">myCertTemplate.setSerialNumber(</code><code class="keyword">new</code><code class="plain"> ASN1Integer(serNo));</code></div>
<div class="line"><code class="comments">// Extension telling revocation reason</code></div>
<div class="line"><code class="plain">ExtensionsGenerator extgen = </code><code class="keyword">new</code><code class="plain"> ExtensionsGenerator();</code></div>
<div class="line"><code class="plain">CRLReason crlReason = CRLReason.lookup(CRLReason.cessationOfOperation);</code></div>
<div class="line"><code class="plain">extgen.addExtension(Extension.reasonCode, </code><code class="keyword">false</code><code class="plain">, crlReason);        </code></div>
<div class="line"><code class="plain">Extensions exts = extgen.generate();</code></div>
<div class="line"><code class="plain">ASN1EncodableVector v = </code><code class="keyword">new</code><code class="plain"> ASN1EncodableVector();</code></div>
<div class="line"><code class="plain">v.add(myCertTemplate.build());</code></div>
<div class="line"><code class="plain">v.add(exts);</code></div>
<div class="line"><code class="plain">ASN1Sequence seq = </code><code class="keyword">new</code><code class="plain"> DERSequence(v);</code></div>
<div class="line"><code class="plain">RevDetails myRevDetails = RevDetails.getInstance(seq);</code></div>
<div class="line"><code class="plain">RevReqContent myRevReqContent = </code><code class="keyword">new</code><code class="plain"> RevReqContent(myRevDetails);</code></div>
<div class="line"><code class="plain">PKIBody myPKIBody = </code><code class="keyword">new</code><code class="plain"> PKIBody(PKIBody.TYPE_REVOCATION_REQ, myRevReqContent); </code><code class="comments">// revocation request</code></div>
<div class="line"><code class="comments">// Message protection and final message</code></div>
<div class="line"><code class="plain">GeneralName sender = </code><code class="keyword">new</code><code class="plain"> GeneralName(userDN);</code></div>
<div class="line"><code class="plain">GeneralName recipient = </code><code class="keyword">new</code><code class="plain"> GeneralName(issuerDN);</code></div>
<div class="line"><code class="plain">ProtectedPKIMessageBuilder pbuilder = </code><code class="keyword">new</code><code class="plain"> ProtectedPKIMessageBuilder(sender, recipient);</code></div>
<div class="line"><code class="plain">pbuilder.setMessageTime(</code><code class="keyword">new</code><code class="plain"> Date());</code></div>
<div class="line"><code class="comments">// senderNonce</code></div>
<div class="line"><code class="plain">pbuilder.setSenderNonce(senderNonce);</code></div>
<div class="line"><code class="comments">// TransactionId</code></div>
<div class="line"><code class="plain">pbuilder.setTransactionID(transactionId);</code></div>
<div class="line"><code class="comments">// Key Id used (required) by the recipient to do a lot of stuff</code></div>
<div class="line"><code class="plain">pbuilder.setSenderKID(</code><code class="string">"KeyId"</code><code class="plain">.getBytes());</code></div>
<div class="line"><code class="plain">pbuilder.setBody(myPKIBody);</code></div>
<div class="line"><code class="plain">JcePKMACValuesCalculator jcePkmacCalc = </code><code class="keyword">new</code><code class="plain"> JcePKMACValuesCalculator();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> AlgorithmIdentifier digAlg = </code><code class="keyword">new</code><code class="plain"> AlgorithmIdentifier(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(</code><code class="string">"1.3.14.3.2.26"</code><code class="plain">)); </code><code class="comments">// SHA1</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> AlgorithmIdentifier macAlg = </code><code class="keyword">new</code><code class="plain"> AlgorithmIdentifier(</code><code class="keyword">new</code><code class="plain"> ASN1ObjectIdentifier(</code><code class="string">"1.2.840.113549.2.7"</code><code class="plain">)); </code><code class="comments">// HMAC/SHA1</code></div>
<div class="line"><code class="plain">jcePkmacCalc.setup(digAlg, macAlg);</code></div>
<div class="line"><code class="plain">PKMACBuilder macbuilder = </code><code class="keyword">new</code><code class="plain"> PKMACBuilder(jcePkmacCalc);</code></div>
<div class="line"><code class="plain">MacCalculator macCalculator = macbuilder.build(</code><code class="string">"password"</code><code class="plain">.toCharArray());</code></div>
<div class="line"><code class="plain">ProtectedPKIMessage message = pbuilder.build(macCalculator);</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-85927124_safe-id-aWQtLkNNUENsaWVudFN1cHBvcnR2Ny40LjAtU2lnbmF0dXJlcHJvdGVjdGVkKENsaWVudG1vZGUpbWVzc2FnZQ">
        <h1 class="heading "><span>Signature protected (Client mode) message</span></h1>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="eclipse syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CertificateRequestMessageBuilder msgbuilder = </code><code class="keyword">new</code><code class="plain"> CertificateRequestMessageBuilder(BigInteger.valueOf(certReqId));</code></div>
<div class="line"><code class="plain">X509NameEntryConverter dnconverter = </code><code class="keyword">new</code><code class="plain"> X509DefaultEntryConverter();</code></div>
<div class="line"><code class="plain">X500Name issuerDN = X500Name.getInstance(</code><code class="keyword">new</code><code class="plain"> X509Name(</code><code class="string">"CN=ManagementCA"</code><code class="plain">).toASN1Object());</code></div>
<div class="line"><code class="plain">X500Name subjectDN = X500Name.getInstance(</code><code class="keyword">new</code><code class="plain"> X509Name(</code><code class="string">"CN=user"</code><code class="plain">, dnconverter).toASN1Object());</code></div>
<div class="line"><code class="plain">msgbuilder.setIssuer(issuerDN);</code></div>
<div class="line"><code class="plain">msgbuilder.setSubject(subjectDN);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[]                  bytes = keyPair.getPublic().getEncoded();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> ByteArrayInputStream    bIn = </code><code class="keyword">new</code><code class="plain"> ByteArrayInputStream(bytes);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> ASN1InputStream         dIn = </code><code class="keyword">new</code><code class="plain"> ASN1InputStream(bIn);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> SubjectPublicKeyInfo keyInfo = </code><code class="keyword">new</code><code class="plain"> SubjectPublicKeyInfo((ASN1Sequence)dIn.readObject());</code></div>
<div class="line"><code class="plain">msgbuilder.setPublicKey(keyInfo);</code></div>
<div class="line"><code class="plain">GeneralName sender = </code><code class="keyword">new</code><code class="plain"> GeneralName(subjectDN);</code></div>
<div class="line"><code class="plain">msgbuilder.setAuthInfoSender(sender);</code></div>
<div class="line"><code class="plain">Control control = </code><code class="keyword">new</code><code class="plain"> RegTokenControl(</code><code class="string">"foo123"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">msgbuilder.addControl(control);</code></div>
<div class="line"><code class="plain">Provider prov = Security.getProvider(BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">ContentSigner popsigner = </code><code class="keyword">new</code><code class="plain"> JcaContentSignerBuilder(</code><code class="string">"SHA256withRSA"</code><code class="plain">).setProvider(prov).build(keyPair.getPrivate());</code></div>
<div class="line"><code class="plain">msgbuilder.setProofOfPossessionSigningKeySigner(popsigner);</code></div>
<div class="line"><code class="plain">CertificateRequestMessage msg = msgbuilder.build();</code></div>
<div class="line"><code class="plain">GeneralName recipient = </code><code class="keyword">new</code><code class="plain"> GeneralName(issuerDN);</code></div>
<div class="line"><code class="plain">ProtectedPKIMessageBuilder pbuilder = </code><code class="keyword">new</code><code class="plain"> ProtectedPKIMessageBuilder(sender, recipient);</code></div>
<div class="line"><code class="plain">pbuilder.setMessageTime(</code><code class="keyword">new</code><code class="plain"> Date());</code></div>
<div class="line"><code class="comments">// senderNonce</code></div>
<div class="line"><code class="plain">pbuilder.setSenderNonce(senderNonce);</code></div>
<div class="line"><code class="comments">// TransactionId</code></div>
<div class="line"><code class="plain">pbuilder.setTransactionID(transactionId);</code></div>
<div class="line"><code class="plain">org.bouncycastle.asn1.crmf.CertReqMessages msgs = </code><code class="keyword">new</code><code class="plain"> org.bouncycastle.asn1.crmf.CertReqMessages(msg.toASN1Structure());</code></div>
<div class="line"><code class="plain">org.bouncycastle.asn1.cmp.PKIBody pkibody = </code><code class="keyword">new</code><code class="plain"> org.bouncycastle.asn1.cmp.PKIBody(org.bouncycastle.asn1.cmp.PKIBody.TYPE_INIT_REQ, msgs);</code></div>
<div class="line"><code class="plain">pbuilder.setBody(pkibody);</code></div>
<div class="line"><code class="plain">ContentSigner msgsigner = </code><code class="keyword">new</code><code class="plain"> JcaContentSignerBuilder(</code><code class="string">"SHA1withRSA"</code><code class="plain">).setProvider(prov).build(keyPair.getPrivate());</code></div>
<div class="line"><code class="plain">ProtectedPKIMessage message = pbuilder.build(msgsigner);</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-85927124_id-.CMPClientSupportv7.4.0-MessagewithMultipleSignatures">
        <h1 class="heading "><span>Message with Multiple Signatures</span></h1>
<p   
>Sample code for a signature protected NestedMessageContent message:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="eclipse syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">String subjectDN = </code><code class="string">"CN=bogusSubjectNested"</code><code class="plain">;</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] nonce = </code><code class="string">"sendernonce"</code><code class="plain">.getBytes();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] transid = </code><code class="string">"trandis"</code><code class="plain">.getBytes();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">PKIMessage crmfMsg = createCrmfReq();</code></div>
<div class="line"><code class="comments">//Signing crmfMsg</code></div>
<div class="line"><code class="plain">KeyPair eeKeys = getAdminKeys();</code></div>
<div class="line"><code class="plain">Certificate adminCert = getAdminCertificate();</code></div>
<div class="line"><code class="plain">ByteArrayInputStream    bIn = </code><code class="keyword">new</code><code class="plain"> ByteArrayInputStream(adminCert.getEncoded());</code></div>
<div class="line"><code class="plain">ASN1InputStream         dIn = </code><code class="keyword">new</code><code class="plain"> ASN1InputStream(bIn);</code></div>
<div class="line"><code class="plain">ASN1Sequence extraAdminCertSeq = (ASN1Sequence)dIn.readObject();</code></div>
<div class="line"><code class="plain">X509CertificateStructure extraCert = </code><code class="keyword">new</code><code class="plain"> X509CertificateStructure(ASN1Sequence.getInstance(extraAdminCertSeq));</code></div>
<div class="line"><code class="plain">crmfMsg.addExtraCert(extraCert);</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">final</code><code class="plain"> Signature sig = Signature.getInstance(PKCSObjectIdentifiers.sha256WithRSAEncryption.getId(), BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">sig.initSign(eekeys.getPrivate());</code></div>
<div class="line"><code class="plain">sig.update(crmfMsg.getProtectedBytes());</code></div>
<div class="line"><code class="keyword">byte</code><code class="plain">[] eeSignature = sig.sign();</code></div>
<div class="line"><code class="plain">crmfMsg.setProtection(</code><code class="keyword">new</code><code class="plain"> DERBitString(eeSignature));</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">PKIHeader myPKIHeader = </code><code class="keyword">new</code><code class="plain"> PKIHeader(</code><code class="keyword">new</code><code class="plain"> DERInteger(</code><code class="value">2</code><code class="plain">), </code><code class="keyword">new</code><code class="plain"> GeneralName(</code><code class="keyword">new</code><code class="plain"> X509Name(subjectDN)), </code><code class="keyword">new</code><code class="plain"> GeneralName(</code><code class="keyword">new</code><code class="plain"> X509Name(((X509Certificate)cacert).getSubjectDN().getName())));</code></div>
<div class="line"><code class="plain">myPKIHeader.setMessageTime(</code><code class="keyword">new</code><code class="plain"> DERGeneralizedTime(</code><code class="keyword">new</code><code class="plain"> Date()));</code></div>
<div class="line"><code class="comments">// senderNonce</code></div>
<div class="line"><code class="plain">myPKIHeader.setSenderNonce(</code><code class="keyword">new</code><code class="plain"> DEROctetString(nonce));</code></div>
<div class="line"><code class="comments">// TransactionId</code></div>
<div class="line"><code class="plain">myPKIHeader.setTransactionID(</code><code class="keyword">new</code><code class="plain"> DEROctetString(transid));</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">PKIBody myPKIBody = </code><code class="keyword">new</code><code class="plain"> PKIBody(crmfMsg, </code><code class="value">20</code><code class="plain">); </code><code class="comments">// NestedMessageContent</code></div>
<div class="line"><code class="plain">PKIMessage myPKIMessage = </code><code class="keyword">new</code><code class="plain"> PKIMessage(myPKIHeader, myPKIBody);</code></div>
<div class="line"><code class="comments">//Signing myPKIMessage</code></div>
<div class="line"><code class="plain">KeyPair raKeys = getRAKeys();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> Signature sig = Signature.getInstance(PKCSObjectIdentifiers.sha256WithRSAEncryption.getId(), BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">sig.initSign(rakeys.getPrivate());</code></div>
<div class="line"><code class="plain">sig.update(myPKIMessage.getProtectedBytes());</code></div>
<div class="line"><code class="keyword">byte</code><code class="plain">[] eeSignature = sig.sign();</code></div>
<div class="line"><code class="plain">myPKIMessage.setProtection(</code><code class="keyword">new</code><code class="plain"> DERBitString(eeSignature));</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">final</code><code class="plain"> ByteArrayOutputStream bao = </code><code class="keyword">new</code><code class="plain"> ByteArrayOutputStream();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> DEROutputStream out = </code><code class="keyword">new</code><code class="plain"> DEROutputStream(bao);</code></div>
<div class="line"><code class="plain">out.writeObject(myPKIMessage);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] ba = bao.toByteArray();</code></div>
<div class="line"><code class="comments">// Send request and receive response</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] resp = sendCmpHttp(ba, </code><code class="value">200</code><code class="plain">);</code></div>
</div>
    </div>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="CMP_3GPP_Operations.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>CMP 3GPP Operations</span>
        </a>
                <a href="SCEP_Operations_Guide.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>SCEP Operations Guide</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
